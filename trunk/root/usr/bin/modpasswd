#!/bin/sh
#
# Usage: modpasswd [load|dsmod]

TMP=/var/tmp
FLASH=$TMP/flash

case "$1" in
	"")
		echo >&2
		echo "## OBSOLETE: modpasswd <no parameters> ##" >&2
		echo "If you want to set the root password, please use the" >&2
		echo "'passwd' command." >&2
		echo >&2
		exit 1
		;;
	load)
		if ! [ -e "$FLASH/shadow.save" ]; then
			echo >&2
			echo "## OBSOLETE: modpasswd load ##" >&2
			echo "If you want to load users, groups and passwords, please use the" >&2
			echo "'modusers load' command." >&2
			echo >&2
			exit 1
		fi

		echo "Obsolete user & password file $FLASH/shadow.save detected, converting..."

		TMPPASSWD=$TMP/.passwd.tmp
		TMPSHADOW=$TMP/.shadow.tmp
		rm -f $TMPPASSWD
		rm -f $TMPSHADOW

		userid=0

		for line in $(cat $FLASH/shadow.save); do
			user="$(echo $line | sed -e 's/:[^:]*$//')"

			if [ "$user" = "root" ]; then
				echo 'root:x:0:0:root:/mod/root:/bin/sh' >> $TMPPASSWD
				[ -d "/mod/root" ] || mkdir /mod/root
			else
				let userid="userid+1"
				echo "$user:x:$userid:1:$user:/mod/home/$user:/bin/sh" >> $TMPPASSWD
				[ -d "/mod/home/$user" ] || mkdir /mod/home/$user
			fi

			echo "$line:12332:0:99999:7:::" >> $TMPSHADOW
		done

		if cat $TMPPASSWD | grep "^root:" > /dev/null; then
			cp $TMPPASSWD /var/tmp/passwd
			cp $TMPSHADOW /var/tmp/shadow
			rm -f $TMPPASSWD
			rm -f $TMPSHADOW

			(
				cd /mod/home/
				for user in *; do
					[ "$user" = "*" ] || chown $user:users $user
				done
			)
		else
			rm -f $TMPPASSWD
			rm -f $TMPSHADOW
			echo "ERROR: no user 'root'" 1>&2
			exit 1
		fi

		echo "Obsolete users & passwords loaded, saving in new format..."
		if /usr/bin/modusers save; then
			echo "Removing obsolete file $FLASH/shadow.save..."
			rm -f $FLASH/shadow.save
			echo "Making data conversion persistent by saving to flash memory..."
			modsave flash
		fi
		;;
	save)
		echo >&2
		echo "## OBSOLETE: modpasswd save ##" >&2
		echo "If you want to save users, groups and passwords, please use the" >&2
		echo "'modusers save' command." >&2
		echo >&2
		exit 1
		;;
	dsmod)
		echo 'Changing password for admin (ds-mod webconfig)'
		echo 'This password should be different from root'"'"'s password.'
		echo 'No "weak password" warnings are generated.'
		echo ''
		echo 'The webinterface may have major bugs allowing to execute'
		echo 'arbitrary code. USE AT YOUR OWN RISK!'
		echo ''

		stty -echo

		echo -n 'Enter new password: '
		read -r passwd1
		echo ''
		echo -n 'Re-enter new password: '
		read -r passwd2
		echo ''

		stty echo

		if [ "$passwd1" != "$passwd2" -o -z "$passwd1" ]; then
			echo 'Passwords do not match or empty password.' 1>&2
			echo 'modpasswd: The password for admin (ds-mod webconfig) is unchanged.' 1>&2
			echo '' 1>&2
			exit 1
		fi

		/usr/bin/modconf set mod MOD_HTTPD_PASSWD=$(/usr/sbin/httpd -m "$passwd1")

		echo 'modpasswd: Password for admin (ds-mod webconfig) changed.'
		echo ''

		/usr/bin/modconf save mod
		[ "$2" = "noflash" ] || /usr/bin/modsave flash
		;;
	*)
		echo >&2
		echo "## OBSOLETE: modpasswd <username> ##" >&2
		echo "If you want to set the a user's password, please use the" >&2
		echo "'passwd' command." >&2
		echo >&2
		exit 1
		;;
esac

exit 0
