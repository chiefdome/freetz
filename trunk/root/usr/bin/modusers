#!/bin/sh

APPLET=${0##*/}

usage() {
	cat << EOF

$0: get/put users, groups & passwords from/to save buffer
Usage: $APPLET {load|save}

Examples:
  # Retrieve data from save buffer (*not* from TFFS)
  $APPLET load

  # Put data to save buffer (*not* to TFFS)
  $APPLET save
  # Make save buffer persistent in TFFS
  modsave flash

EOF
}

[ $# -eq 0 ] && usage && exit 0
[ $# -ne 1 ] && usage >&2 && exit 1

PATH=/sbin:/bin:/usr/sbin:/usr/bin
USER_DIR=/tmp/flash/users
TMP_DIR=/tmp
FILES="passwd group shadow gshadow"

case "$1" in
	save)
		rm -rf $USER_DIR
		mkdir -pm 700 $USER_DIR
		( cd $TMP_DIR && cp -a $FILES $USER_DIR	)
		;;
	load)
		for f in $FILES; do
			if [ -e $USER_DIR/$f ]; then
				cp -a $USER_DIR/$f $TMP_DIR
			fi
		done
		cat /etc/passwd | while IFS=: read user pass uid gid gecos user_homedir shell; do
			mkdir -p "$user_homedir"
			chown $uid:$gid "$user_homedir"
		done
		;;
	*)
		usage >&2
		exit 1
		;;
esac
