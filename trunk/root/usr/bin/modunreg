#!/bin/sh
#
# Usage: modunreg cgi <pkg>
#        modunreg pkg <pkg>
#        modunreg conf <pkg> [<id>]
#        modunreg extra <pkg> [<cgi-name>]
#        modunreg file <pkg> [<id>]
#        modunreg status <pkg> [<cgi-name>]
#        modunreg daemon <pkg> [<daemon>]

char=$(echo -ne '\01')

delete() {
	local regexp=$1 file=$2
	[ -e "$file" ] || touch "$file"

	# replace $file atomically
	sed -i "\\${char}$regexp${char}d" "$file"
}

case $1 in
	cgi)
		"$0" conf "$2" _index
		;;
	pkg)
		delete "^$2|" /mod/etc/reg/pkg.reg
		touch /mod/var/cache/menu.stale
		;;
	conf)
		delete "^$2|${3:-[^|]*}|" /mod/etc/reg/conf.reg
		touch /mod/var/cache/menu.stale
		;;
	extra)
		delete "^$2|.*|${3:-[^|]*}\$" /mod/etc/reg/extra.reg
		rm -f /mod/var/cache/extras
		touch /mod/var/cache/menu.stale
		;;
	file)
		delete "^${2}|${3:-[^|]*}|" /mod/etc/reg/file.reg
		touch /mod/var/cache/menu.stale
		;;
	status)
		delete "^$2|.*|${3:-[^|]*}\$" /mod/etc/reg/status.reg
		touch /mod/var/cache/menu.stale
		;;
	daemon)
		delete "^${3:-[^|]*}|.*|$2\$" /mod/etc/reg/daemon.reg
		;;
	*)
		echo "Usage: $0 cgi <pkg>" 1>&2
		echo "       $0 extra <pkg> [<cgi-name>]" 1>&2
		echo "       $0 file <pkg> [<id>]" 1>&2
		echo "       $0 status <pkg> [<cgi-name>]" 1>&2
		echo "       $0 daemon <pkg> [<daemon>]" 1>&2
		exit 1
		;;
esac

exit 0
