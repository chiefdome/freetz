#!/bin/sh

APPLET=${0##*/}

usage() {
	cat << EOF

$0: add/delete user
Usage: $APPLET {add|del} {<username>} [noflash]

Use the optional parameter 'noflash' if you want to do several changes and
commit them only at the last call, e.g. like this:

  # Add two users + passwords, don't save to flash
  moduser add deanna noflash
  modpasswd deanna noflash
  moduser add beverly noflash
  modpasswd beverly noflash
  # Final action: delete user, save to flash
  moduser del tasha

EOF
}

[ $# -eq 0 ] && usage && exit 0
[ $# -lt 2 ] || [ $# -eq 3 -a "$3" != "noflash" ] && usage >&2 && exit 1

PATH=/sbin:/bin:/usr/sbin:/usr/bin
TMP=/tmp
FLASH=$TMP/flash/shadow.save
PASSWD=/etc/passwd

case "$1" in
	add)
		if grep -q "^$2:" $PASSWD > /dev/null; then
			echo "$APPLET: user $2 exists" >&2
			exit 1
		fi
		modpasswd save noflash
		echo "$2:*" >> $FLASH
		modpasswd load
		echo "$APPLET: user $2 added"
		;;
	del)
		if ! grep -q "^$2:" $PASSWD > /dev/null; then
			echo "$APPLET: user $2 does not exist" >&2
			exit 1
		fi
		modpasswd save noflash
		grep -v "^$2:" $FLASH > $TMP/.shadow
		mv $TMP/.shadow $FLASH
		rm -rf /mod/home/$2
		modpasswd load
		echo "$APPLET: user $2 deleted"
		;;
	*)
		usage >&2
		exit 1
		;;
esac

chmod 600 $FLASH
[ "$3" ] || modsave flash
