#!/bin/sh

APPLET=${0##*/}

usage() {
	cat << EOF

$0: add/delete user
Usage: $APPLET {add|del} <username>

Example:
  # Add two users + passwords, don't save to flash
  $APPLET add deanna
  modpasswd deanna noflash
  $APPLET add beverly
  modpasswd beverly noflash
  # Final action: delete user, save to flash
  $APPLET del tasha
  modsave flash

EOF
}

[ $# -eq 0 ] && usage && exit 0
[ $# -ne 2 ] && usage >&2 && exit 1

PATH=/sbin:/bin:/usr/sbin:/usr/bin
TMP=/tmp
FLASH=$TMP/flash/shadow.save
PASSWD=/etc/passwd

case "$1" in
	add)
		if grep -q "^$2:" $PASSWD > /dev/null; then
			echo "$APPLET: user $2 exists" >&2
			exit 1
		fi
		modpasswd save
		echo "$2:*" >> $FLASH
		modpasswd load
		echo "$APPLET: user $2 added"
		;;
	del)
		if ! grep -q "^$2:" $PASSWD > /dev/null; then
			echo "$APPLET: user $2 does not exist" >&2
			exit 1
		fi
		modpasswd save
		grep -v "^$2:" $FLASH > $TMP/.shadow
		mv $TMP/.shadow $FLASH
		rm -rf /mod/home/$2
		modpasswd load
		echo "$APPLET: user $2 deleted"
		;;
	*)
		usage >&2
		exit 1
		;;
esac

chown root:root $FLASH
chmod 600 $FLASH
