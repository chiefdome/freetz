===================================================
==  To-do list and collection of ideas for ds26  ==
===================================================

$Id$


HIGH PRIORITY - critical bugs, important features
-------------------------------------------------

- bftpd, vsftpd: Configuration file has to be rewritten after change - see
  next item
  Status (by Oliver): Done, needs testing

- Find out why user 'ftp' is created multiple times (maybe once at each
  reboot?). My configuration currently has six instances.

- Find out why firmware upload on W701V does not return protocol to web UI.
  Could be Haserl or Busybox, olistudent suspects the latter. Strange enough,
  the same thing works with identical BB and Haserl on 7170.
    Update (by kriegaex): Maybe it was pure chance that it worked when I tried
    once on 7170, because sometimes it also works on W701V. It is a sporadic
    error happening in >50% of my test cases. It is independent of a specific
    Haserl version, so the next natural suspect has now become BusyBox 1.7.2.
    The whole problem looks like a race condition. Nathan Angelacos, Haserl's
    author, has been notified. Maybe he can pin down the error.
    Status (by Oliver): Problem seems to be solved with patch from Ralf, firmware-
    update button is working again for me.

- Where do strange hostnames like "Speedport-W-701V-33.04.44" or
  "FRITZ-Box-Fon-WLAN-7170-(UI)-29.04.40" come from?
  Remark (by Oliver): I think from multid. How could we avoid that?

- Check order in which packages are started at boottime (virtualip, ntfs,
  cifsmount, syslog-cgi)

- New UNIX-conform user/group/password management
  (assigned to kriegaex)
  Stage 1 (done):
  * Old user management still in place and default (e.g. used by modload)
  * New user management already usable
  * Busybox now includes applets adduser, deluser, addgroup, delgroup, cryptpw.
    This costs an additional 6,104 bytes, which is pretty good.
  * fwmod creates symlink /home -> var/mod/home because adduser expects to find
    /home if no explicit home dir parameter is specified
  * fwmod creates symlink /etc/gshadow -> /var/tmp/gshadow and also creates an
    empty /var/tmp/gshadow because BB tools expect file to be writable
  * New script modusers (not to confuse for moduser without "s") loads/saves
    /tmp/{passwd,shadow,group,gshadow} from/to save buffer in /tmp/flash/users
  Stage 2 (yet to do):
  * Make ds26 + packages like Bftpd and Samba use BB tools instead of
    proprietary scripts wherever possible
  * Replace obsolete scripts or parts of them by warning messages telling users
    that those obsolete parts will vanish soon
  * Get rid of /tmp/flash/shadow.save
  * Change modload & modsave to use modusers instead of modpasswd
  * Provide default passwords for root and ds26 web user + warnings to change
    them, maybe even via Web (I already found out how to control the
    interactive passwd tool without user interaction)
  * Update Wiki (general user management article pointing to Linux standard
    documentation, package articles for Samba & Bftpd, ds26 installation how-to
    concerning first-time password entry)
  * Possible get rid of special case "telnet login with AVM web password if no
    root pw is set", because root will have a default pw packaged right into
    var.tar.
  * Decide whether to include auto-conversion scripts for shadow.save or just
    mention how to upgrade/downgrade in the IPPF release thread.


MEDIUM PRIORITY - normal bugs, features, improvements
-----------------------------------------------------

- MD5 checksums for DS-Mod packages (our own as well as external ones) incl.
  necessary make macros or shell scripts

- Make ccache build script aware of gcc version change (needs rebuild in that
  case)

- Possibly add patch to rc.S according or similar to
  http://www.ip-phone-forum.de/showthread.php?p=949145#post949145
  so as to make sure that the network is up before starting dsld. Otherwise
  there might be problems, i.e. dsld does not start during the boot process
  and must be started manually later. If this only happens in ATA or also in
  DSL mode, is unknown.

- Think about whether we can do something about LCR Auto Updater not working
  without httpd restart, if httpd replaces websrv.
    Remark (by kriegaex): FAQ item in IPPF tells users to add a restart call
    at the end of the LCR installation procedure. This is not a perfect
    solution, but a good workaround.

- Find a better place for iptables libs

- Enhance Virtual-IP-CGI and Openntpd so it supports other (and possibly
  multiple) interfaces than lan:1
  (http://www.ip-phone-forum.de/showpost.php?p=886345)
    Remark (by Oliver): Add interface option to webinterface (virtualip).
    Openntpd uses eth0 in ethmode_router and lan in ethmode_bridge.

- Get "telnetd vs. setconsole" hangups fixed in BusyBox or another way.
    Status (by kriegaex): reported to BusyBox mailing list, let's wait & hope.
    http://busybox.net/lists/busybox/2007-October/029008.html

- Refactor Dnsmasq package, particularly rc.dnsmasq (full of logical mistakes!)
  and recently improved, but still suboptimal multid wrapper. The whole thing
  only (kind of) works as long as nobody thinks about using the scripts outside
  the init process. Otherwise they might work, but could also break. For
  example, the "start" action does not check if the package is activated at
  all. The "load" action does, but does not take care of starting multid anyway
  if Dnsmasq is deactivated. A few more strange things are in there, e.g. the
  misleading variable name "nomultid" which suggests there is an option to run
  Dnsmasq without multid. This is not true, the variable is just a flag which
  means something like "don't start/stop multid, I will take care of it
  myself". This is used in the restart action where the option keeps "stop" and
  "start" from restarting multid twice. Actually, I (kriegaex) do not feel so
  inclined to refactor those scripts myself. It took me a while to at least
  understand what they do and fix a few quoting bugs in the wrapper.

- Vpnc package: Make hybrid auth feature configureable over webinterface

- Include polished version of swap space package, see
  http://www.ip-phone-forum.de/showthread.php?t=148245.
  Probably we should pretty much redo the package, because the scripts and
  DS-Mod UI integration are quite ugly.
  Remark (by Oliver): Should we provide some button/menu to create a swapfile?

- Optionally stop DS-Mod services before firmware upgrade

- Rudi Shell: utilise new FIFO uploading feature in order to enable uploads to
  specific locations instead of to temp-files with unpredictablöe names which
  need to be moved afterwards. The feature is already used by the firmware
  upgrade assistant, so it seems like a good idea to use it elsewhere, too.


LOW PRIORITY - nice to have, cosmetics, ideas
---------------------------------------------

- Make OPIE (One Time Passwords in Everything) work with telnet, FTP and SSH
  daemons.
    Remark (by kriegaex): I have it running on my box with BusyBox telnetd
    after having replaced /bin/login by opielogin. But in order to make it work
    with Dropbear we either need a patch so Dropbear authenticates users via
    opielogin or have to include a full-fledged PAM (Pluggable Authentication
    Modules) infrastructure into ds26. Apart from getting it to compile at all,
    I do not know how big the payload would be. That is why I put it into this
    list, after all.
    Update (by kriegaex): Now we have BusyBox 1.7.2 with PAM login support, so
    maybe we can have another look at the Dropbear issue now, provided I can
    figure out how to do that.

- Experiment with and possibly use dietlibc to create smaller binaries by
  statically compiling in stuff usually dynamically linked to uClibc.
    Status (by kriegaex): compiled a few binaries - thanks to olistudent for
    providing a working dietlibc - which are usually a bit smaller than their
    BusyBox counterparts, but the differences are not as dramatic as hoped for.
    I think we should try some more packages in order to see where it helps
    and where it does not. I think good candidates would be packages using one
    or more libs pretty exclusively, i.e. the libs are not used by many other
    packages. In this case we could save some overall space by creating static
    binaries with dietlibc, especially if only a smaller part of the libs'
    functionalities are used.

- Check possibilities of inetd-enabling more services, see e.g.
  http://www.ip-phone-forum.de/showpost.php?p=949387.
  I think we should ask the guy who created the package to do that for us.

- Rudi Shell: add switch to send stderr output to stdout ('2>&1') for lazy
  users who do not know how to do it otherwise.
    Remark (by kriegaex): I think we should avoid making Rudi's UI more fancy
    than necessary. (Keep it simple, stupid!) Rudi stands for rudimentary,
    after all.

- Make rc.mini_fo use kernel_args API

- Maybe we can offer including the binary 'urlader.setconfig26' from 06.04.33
  as a debug tool so users can change the read-only status of bootloader
  variables. Priority: fairly low, nice to have.

- Suggestion by Knox: use awx, an extension to awk, as CGI handler instead of
  Haserl.
    Remark (by kriegaex): Maybe it would work beautifully, I do not know. But
    probably it would mean doing the whole web UI from scratch and completely
    remove the Haserl stuff. I think three solutions (plain shell, Haserl and
    awx) would be too much and overkill for maintenance. We should remember
    awx, though, if we ever decide to do everything from scratch or start a
    big refactoring project.

- Idea from somewhere in IPPF: implement some kind of auto-update functionality
  for ds26, especially for patches in between releases. This would lead to
  fewer questions in the forum and more flexibility as well as a more
  consistent code base "in the wild", i.e. pretty much all modders using the
  same set of patches instead of everybody using a more or less different
  setup.

- Idea by heini66: implement call-back function as an add-on to DTMF-Box, see
  http://www.ip-phone-forum.de/showpost.php?p=941080&postcount=698 and
  http://www.blindi.net/callback/index.php.

- Idea by heini66: port Softmac WLAN driver from Openwrt. Goal is ad-hoc
  networking, e.g. for Freifunk.

- Open question: Why do we have libjpeg if it is not used by any package?
    Answer (by olistudent): SANE seems to need it, but the scanners do not run
    because AVM have not finished their USB driver yet. We should check new
    packages to see if they ever provide a working version.


FINISHED, NEEDS TESTING
-----------------------

- Bump uClibc to 0.9.29
    Status (by Oliver): Done. But AVM daemons don't like it.

- Check bftpd, dropbear, netsnmp and openvpn (try to make suboptions instead of
  multiple packages)
    Remark (by olistudent): Done. But it needs testing. Open question: Are
    there options in cfg files that conflict with the features compiled in
    (e.g. OPENVPN_MGMNT)?

- Idea by heini66: optionally remove dsld from image, because it is supposedly
  not needed in ATA mode.
    Remark (by kriegaex): According to the discussion under
    http://www.ip-phone-forum.de/showthread.php?t=148885 dsld *is* needed in
    ATA mode, at least in PPPoE-passthrough mode (see screenshot at
    http://www.ip-phone-forum.de/attachment.php?attachmentid=18739&d=1190878250).
    Maybe it is not needed in IP client mode. Can somebody clarify this with
    another comment, please?
    Update (by kriegaex): heini66 tested without dsld on W900V, 7050, FON WLAN,
    W501V in IP client mode, and it works. Olistudent also says dsld is only
    needed in PPoE-passthrough mode, so I think we can risk offering a patch. I
    just prepared one, and it deletes
      * /sbin/dsld                           (131 KB)
      * /sbin/showdsldstat                   ( 10 KB)
      * /lib/modules/*/kernel/drivers/dsld/* (772 KB)
    File sizes are from 29.04.29. Hopefully, userman.ko is not loaded in
    IP-client mode, because it needs kdsldmod.ko. This is yet to be tested
    before a release, we may have to keep this huge module in the image if it
    is needed. The patch also changes rc.init settings DSL=n, VDSL=n.

- Check out Xrelayd [1], the successor of Matrixtunnel [2]:
    [1] http://forum.openwrt.org/viewtopic.php?id=12338
    [2] http://forum.openwrt.org/viewtopic.php?id=5588
  If Xrelayd is better, smaller, whatever... than Matrixtunnel, replace MT
  package by XRD package.
    Status (by kriegaex): The package is ready and functional. Stripped binary
    size comparison:
      matrixssl:     84.4 k  /  xyssl:   137.5 k
      matrixtunnel:  24.2 k  /  xrelayd:  18.4 k
      ------------------------------------------
      matrix*:      108.6 k  /  x*:      155.9 k
    Question to olistudent: Should we switch, given the fact that x* is 44%
    bigger than matrix*? There are hints for making the lib smaller [3], but
    most of the options are already used, we are close to minimum size. What
    might also make xyssl interesting is the fact that it does not seem to be
    semi-commercial like matrixssl. Furthermore, it seems to be fairly easy to
    create an OpenSSL wrapper [4]. If this would work for our other packages
    depending on OpenSSL, it would be a huge gain, not only for the owners of
    small boxes.
      [3] http://www.xyssl.org/forum/?0048
      [4] http://xyssl.org/forum/?0050

- Bump busybox version to 1.7.2
    Status (by kriegaex): done. Several patches were removed, others fixed and
    a few renamed to '*.broken' because I was not 100% sure they are not needed
    anymore or I believe the corresponding applets should be tested, so we
    know they now work without the old patches.

- Samba: Should have problems with big files?
    Status (by kriegaex): I just tested copying a directory containing several
    2-5 MB files over to my USB hard disk via DS-Mod's Samba version
    (2.0.10-security-rollup). The partition mounted is an ext3 24 GB partition.
    No swap space was used during the test. Afterwards I copied a 700 MB ISO
    image which also worked flawlessly. I double-checked the MD5 sum and also
    monitored the CPU load via top. Result: On average there was 13% load by
    smbd and something like 1% for each of ksoftirqd (some peaks with up to
    15%) and kjournald, less than 1% for usbstorage. All copy actions were
    performed by Total Commander 6.5. By the way: User and group names
    (root:root) were correct for all files and dirs created on the ext3 share
    via shell commandline and Windows (TC).

- Integrate package brctl (assigned to Ralf)
    Done. Maybe integrate brctl into busybox?

- Test if it is possible to strip userman.ko and usermand from FW image.
  "Userman" means "user management" and is responsible for the "child safety"
  option (Kindersicherung).
    Status (by Oliver): done. Perhaps we should we disable option for some
    boxes.
    Remark (by kriegaex): Three current firmwares do not have 'usermand':
      - 5140  (43.04.37)
      - W501V (28.04.38)
      - W900V (34.04.21)
    Thoose three also do not have 'KIDS=y' in rc.init, so it seems logical to
    disable the patch for them. I have done just that.

- Integrate new firmware for W701 (thanks to heini66 for the hint):
  http://www.t-home.de/dlp/eki/downloads/Speedport/Speedport%20W%20701%20V/fw_Speedport_W701V_v33.04.44.image
    Status (by Oliver): done, but web interface needs testing.
    Status (by kriegaex): I have not tested the web UI, but otherwise it seems
    to work beautifully, even with "replace kernel" based on *.40 GPL package.
    One strange thing remains, though - see next item.
