-include $(TOOLCHAIN_DIR)/make/kernel/*/Makefile.in
-include $(TOOLCHAIN_DIR)/make/target/*/Makefile.in

REAL_GNU_KERNEL_NAME:=mipsel-unknown-linux-gnu

KERNEL_TOOLCHAIN_GCC_VERSION:=$(strip $(subst ",, $(FREETZ_KERNEL_GCC_VERSION)))
KERNEL_TOOLCHAIN_BINUTILS_VERSION:=$(strip $(subst ",, $(FREETZ_KERNEL_BINUTILS_VERSION)))
KERNEL_TOOLCHAIN_DIR:=$(FREETZ_BASE_DIR)/$(SOURCE_DIR_ROOT)/toolchain/kernel
KERNEL_TOOLCHAIN_SYMLINK:=$(FREETZ_BASE_DIR)/$(TOOLCHAIN_DIR)/kernel
KERNEL_TOOLCHAIN_SYMLINK_DOT_FILE:=$(FREETZ_BASE_DIR)/$(TOOLCHAIN_DIR)/.kernel
KERNEL_TOOLCHAIN_COMPILER:=gcc-$(KERNEL_TOOLCHAIN_GCC_VERSION)
KERNEL_TOOLCHAIN_STAGING_DIR:=$(FREETZ_BASE_DIR)/$(TOOLCHAIN_BUILD_DIR)/$(KERNEL_TOOLCHAIN_COMPILER)/$(REAL_GNU_KERNEL_NAME)

KERNEL_TOOLCHAIN_PATH:=$(KERNEL_TOOLCHAIN_STAGING_DIR)/bin:/bin:/sbin:/usr/bin:/usr/sbin

_empty:=
_space:=$(_empty) $(_empty)
define GET_MAJOR_VERSION
$(strip $(subst $(_space),.,$(wordlist 1,$(if $(2),$(2),2),$(subst .,$(_space),$(1)))))
endef

TARGET_TOOLCHAIN_GCC_VERSION:=$(strip $(subst ",, $(FREETZ_TARGET_GCC_VERSION)))
TARGET_TOOLCHAIN_GCC_MAJOR_VERSION:=$(call GET_MAJOR_VERSION,$(TARGET_TOOLCHAIN_GCC_VERSION))
TARGET_TOOLCHAIN_UCLIBC_VERSION:=$(strip $(subst ",, $(FREETZ_TARGET_UCLIBC_VERSION)))
TARGET_TOOLCHAIN_BINUTILS_VERSION:=$(strip $(subst ",, $(FREETZ_TARGET_BINUTILS_VERSION)))
TARGET_TOOLCHAIN_BINUTILS_MAJOR_VERSION:=$(call GET_MAJOR_VERSION,$(TARGET_TOOLCHAIN_BINUTILS_VERSION))

TARGET_TOOLCHAIN_UCLIBC_REF:=$(strip $(subst ",, $(FREETZ_TARGET_UCLIBC_REF)))
TARGET_TOOLCHAIN_GDB_VERSION:=$(strip $(subst ",, $(FREETZ_GDB_VERSION)))

TARGET_TOOLCHAIN_SYMLINK:=$(FREETZ_BASE_DIR)/$(TOOLCHAIN_DIR)/target
TARGET_TOOLCHAIN_SYMLINK_DOT_FILE:=$(FREETZ_BASE_DIR)/$(TOOLCHAIN_DIR)/.target
TARGET_TOOLCHAIN_COMPILER:=gcc-$(TARGET_TOOLCHAIN_GCC_VERSION)-uClibc-$(TARGET_TOOLCHAIN_UCLIBC_VERSION)
TARGET_TOOLCHAIN_DIR:=$(FREETZ_BASE_DIR)/$(SOURCE_DIR_ROOT)/toolchain/target/$(TARGET_TOOLCHAIN_COMPILER)
TARGET_TOOLCHAIN_STAGING_DIR:=$(FREETZ_BASE_DIR)/$(TOOLCHAIN_BUILD_DIR)/$(TARGET_TOOLCHAIN_COMPILER)/$(REAL_GNU_TARGET_NAME)
TARGET_UTILS_DIR:=$(TARGET_TOOLCHAIN_STAGING_DIR)/target-utils

ifeq ($(strip $(FREETZ_BUILD_TOOLCHAIN)),y)
TOOLCHAIN+=kernel-toolchain
TOOLCHAIN+=target-toolchain
else
TOOLCHAIN:=download-toolchain
endif

$(KERNEL_TOOLCHAIN_SYMLINK_DOT_FILE): $(TOPDIR)/.config
	@$(RM) $(KERNEL_TOOLCHAIN_SYMLINK)
	@ln -fs $(BUILD_DIR)/$(KERNEL_TOOLCHAIN_COMPILER)/$(REAL_GNU_KERNEL_NAME) $(KERNEL_TOOLCHAIN_SYMLINK)
	@touch $@

$(TARGET_TOOLCHAIN_SYMLINK_DOT_FILE): $(TOPDIR)/.config
	@$(RM) $(TARGET_TOOLCHAIN_SYMLINK)
	@ln -fs $(BUILD_DIR)/$(TARGET_TOOLCHAIN_COMPILER)/$(REAL_GNU_TARGET_NAME) $(TARGET_TOOLCHAIN_SYMLINK)
	@touch $@

toolchain-dirclean: kernel-toolchain-dirclean target-toolchain-dirclean

toolchain-distclean: kernel-toolchain-distclean target-toolchain-distclean
	$(RM) -r $(TOOLCHAIN_BUILD_DIR)

kernel-toolchain-distclean: kernel-toolchain-dirclean
	$(RM) -r $(SOURCE_DIR_ROOT)/toolchain/kernel
	$(RM) $(TOOLCHAIN_DIR)/kernel
	$(RM) $(KERNEL_TOOLCHAIN_SYMLINK_DOT_FILE)

target-toolchain-distclean: target-toolchain-dirclean
	$(RM) -r $(SOURCE_DIR_ROOT)/toolchain/target
	$(RM) $(TOOLCHAIN_DIR)/target
	$(RM) $(TARGET_TOOLCHAIN_SYMLINK_DOT_FILE)

include $(TOOLCHAIN_DIR)/make/toolchain-common.in
