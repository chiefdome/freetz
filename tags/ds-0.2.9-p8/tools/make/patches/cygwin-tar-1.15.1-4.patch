diff -urN -X tar-1.15.1-filter -x build tar-1.15.1-orig/CYGWIN-PATCHES/setup.hint tar-1.15.1/CYGWIN-PATCHES/setup.hint
--- tar-1.15.1-orig/CYGWIN-PATCHES/setup.hint	1969-12-31 17:00:00.000000000 -0700
+++ tar-1.15.1/CYGWIN-PATCHES/setup.hint	2005-08-13 14:35:48.000000000 -0600
@@ -0,0 +1,9 @@
+sdesc: "A GNU file archiving program"
+ldesc: "The GNU tar program saves many files together in one archive
+and can restore individual files (or all of the files) from that
+archive. Tar can also be used to add supplemental files to an archive and
+to update or list files in the archive. Tar includes multivolume support,
+automatic archive compression/decompression, the ability to perform
+remote archives, and the ability to perform incremental and full backups."
+category: Base
+requires: bash bzip2 cygwin gzip libintl3 libiconv2
diff -urN -X tar-1.15.1-filter -x build tar-1.15.1-orig/CYGWIN-PATCHES/tar.README tar-1.15.1/CYGWIN-PATCHES/tar.README
--- tar-1.15.1-orig/CYGWIN-PATCHES/tar.README	1969-12-31 17:00:00.000000000 -0700
+++ tar-1.15.1/CYGWIN-PATCHES/tar.README	2006-03-13 06:57:34.000000000 -0700
@@ -0,0 +1,84 @@
+tar-1.15.1-4
+------------------------------------------
+GNU Tar is an archiver program. It is used to create and manipulate
+files that are actually collections of many other files; the program
+provides users with an organized and systematic method of controlling
+a large amount of data.  Despite its name, that is an acronym of "tape
+archiver", GNU Tar is able to direct its output to any available
+devices, files or other programs, it may as well access remote devices
+or files.  The main areas of usage for GNU Tar are: storage, backup
+and transportation.
+
+Runtime requirements (these, or newer):
+- Minimal features
+  cygwin-1.5.19-4
+  libiconv2-1.9.2-2
+  libintl3-0.14.5-1
+- Use of -Z, -z, and -j flags
+  bash-3.0-14
+  bzip2-1.0.3-1
+  gzip-1.3.5-1
+
+Build requirements (these, or newer):
+  bash-3.0-14
+  binutils-20050610-1
+  gcc-3.4.4-1
+
+Canonical homepage:
+  http://www.gnu.org/software/tar/
+
+Canonical download:
+  http://ftp.gnu.org/gnu/tar
+
+License:
+  GPL
+
+Language:
+  C
+
+------------------------------------
+
+Build instructions:
+  unpack tar-1.15.1-4-src.tar.bz2
+    if you use setup to install this src package, it will be
+	 unpacked under /usr/src automatically
+  cd /usr/src
+  ./tar-1.15.1-4.sh all
+
+This will create:
+  /usr/src/tar-1.15.1-4.tar.bz2
+  /usr/src/tar-1.15.1-4-src.tar.bz2
+
+Or use './tar-1.15.1-4.sh prep' to get a patched source directory
+
+To find out the files included in the binary distribution, you can use
+"cygcheck -l tar", or browse the listing for the appropriate version
+at <http://cygwin.com/packages/>.
+
+------------------
+
+Port Notes:
+
+----------  tar-1.15.1-4 -- 2006-03-13 -----------
+Apply gentoo patch for security issue CVE-2006-0300.
+
+----------  tar-1.15.1-3 -- 2005-12-22 -----------
+Backport upstream fix to avoid abort with -rz.  Avoid dirent.d_ino,
+since it was never valid.
+
+----------  tar-1.15.1-2 -- 2005-08-18 -----------
+Fix regression in incremental mode from 1.13.25-7.  Allow \r in
+filenames when --null is specified.
+
+----------  tar-1.15.1-1 -- 2005-08-16 -----------
+New maintainer: Eric Blake.  New upstream release.
+
+----------  tar-1.13.25-7 -------------
+Earlier releases were maintained by Christopher Faylor.  See
+cygwin-apps mailing lists for announcements.
+
+For more information about this package, see the upstream documentation in
+/usr/share/doc/tar-1.15.1.
+
+Cygwin port maintained by: Eric Blake <ebb9@byu.net>
+Please address all questions to the Cygwin mailing list at <cygwin@cygwin.com>
diff -urN -X tar-1.15.1-filter -x build tar-1.15.1-orig/ChangeLog tar-1.15.1/ChangeLog
--- tar-1.15.1-orig/ChangeLog	2004-12-21 07:45:10.000000000 -0700
+++ tar-1.15.1/ChangeLog	2006-03-13 06:26:46.000000000 -0700
@@ -1,3 +1,53 @@
+2006-03-13  Eric Blake  <ebb9@byu.net>
+
+	Cygwin 1.15.1-4 release.
+	* src/xheader.c: Apply gentoo patch for CVE-2006-0300 security
+	vulnerability:
+	http://www.gentoo.org/security/en/glsa/glsa-200603-06.xml.
+
+2005-12-22  Eric Blake  <ebb9@byu.net>
+
+	Cygwin 1.15.1-3 release.
+	* src/tar.c (decode_options): Backport CVS fix to avoid abort
+	with -rz or -Az option pairs.
+
+2005-08-18  Eric Blake  <ebb9@byu.net>
+
+	Cygwin 1.15.1-2 release.
+	* src/buffer.c (closeout_volume_number): Yet more forced binary
+	writes.
+	* src/incremen.c (read_directory_file): Strip \r from filenames,
+	which breaks managed mounts with trailing \r for the sake of
+	compatibility with incremental listing from 1.13.25-7.
+	* src/names.c (name_init): With --null, force binary read.
+	Otherwise, forced text read, which breaks managed mounts with
+	trailing \r for the sake of compatibility with 1.13.25-7.
+
+2005-08-16  Eric Blake  <ebb9@byu.net>
+
+	Cygwin 1.15.1-1 release.
+	* m4/rmt.m4 (PU_RMT): Account for $EXEEXT when building rmt.
+	* lib/rmt.h (rmtopen, rmtcreat): Force binary mode.
+	* rmt/rmt.c (main): Ditto.
+	* src/buffer.c (open_archive, new_volume): Ditto.
+	* src/create.c (check_cache_directory): Ditto.
+	* src/delete.c (delete_archive_members): Ditto.
+	* src/extract.c (extract_archive): Ditto.
+	* src/incremen.c (read_directory_file): Ditto.
+	* src/system.c (sys_child_open_for_compress): Ditto.
+	* tests/genfile.c (generate_simple_file, generate_sparse_file): Ditto.
+	* tests/Makefile.am (TESTSUITE_AT): Fix packaging bug.
+	* tests/append.at: Missing from upstream package.
+	* tests/append01.at: Ditto.
+	* tests/ignfail.at: Don't skip on cygwin.
+
+2005-08-13  Christopher Faylor  <cgf@timesys.com>
+
+	* src/extract.c (apply_delayed_symlinks): On win9x, link() creates
+	copies, so comparing inodes doesn't work.
+	* src/incremen.c (read_directory_file, write_directory_file_entry):
+	On cygwin, ino_t is bigger than unsigned long.
+
 2004-12-21  Sergey Poznyakoff  <gray@Mirddin.farlep.net>
 
 	* configure.ac: Raise version number to 1.15.1
@@ -16,18 +66,18 @@
 	* tests/Makefile.am (comprec.at,pipe.at): New tests
 	* tests/testsuite.at: Likewise
 	* tests/gzip.at: Use AT_GZIP_PREREQ
-	* tests/star/pax-big-10g.at: Likewise 
+	* tests/star/pax-big-10g.at: Likewise
 	* tests/star/ustar-big-2g.at: Likewise
 	* tests/star/ustar-big-8g.at: Likewise
-	
+
 	* tests/extrac04.at: Discard stderr from sort, on some
 	systems it spits out lots of irrelevant info.
 	* tests/listed02.at: Likewise
-	
+
 	* doc/index.html.in: Rewritten in xhtml to follow recent
 	GNU site standards.
 	* THANKS: Updated
-	
+
 2004-12-20  Sergey Poznyakoff  <gray@Mirddin.farlep.net>
 
 	Released version 1.15. Sources up to this point are
@@ -38,12 +88,12 @@
 	* directory: Updated
 	* bootstrap (update_po): Give -r to wget. Always remove index.html
 	Ignore alloca-opt module (it duplicates alloca)
-	
+
 	* tests/Makefile.am: Distribute star/quicktest.sh
 	* tests/star/README: Document quicktest.sh
 	* tests/star/qucktest.sh: Removed.
-	* tests/star/quicktest.sh: New file. 
-	
+	* tests/star/quicktest.sh: New file.
+
 2004-12-18  Sergey Poznyakoff  <gray@Mirddin.farlep.net>
 
 	* NEWS: Updated
@@ -52,7 +102,7 @@
 	* src/tar.c (decode_options): Ignore --seek if used with --delete.
 	Delete.c is based on the assumption that the archive is being
 	actually read, not lseeked.
-	
+
 	* tests/delete05.at: New file
 	* tests/extrac02.at: Fixed typo in AT_SETUP
 	* tests/Makefile.am: Added delete05.at
@@ -540,7 +590,7 @@
 	* bootstrap: New option --update-po
 	* src/tar.c: New option -H (short alias to --format)
 	* doc/tar.texi: Document -H option
- 	* src/names.c (safer_name_suffix): Fixed bug introduced
+	* src/names.c (safer_name_suffix): Fixed bug introduced
 	2004-05-11.
 
 2004-05-16  Sergey Poznyakoff  <gray@Mirddin.farlep.net>
diff -urN -X tar-1.15.1-filter -x build tar-1.15.1-orig/Makefile.in tar-1.15.1/Makefile.in
--- tar-1.15.1-orig/Makefile.in	2004-12-21 06:31:04.000000000 -0700
+++ tar-1.15.1/Makefile.in	2005-08-13 13:12:33.000000000 -0600
@@ -1,8 +1,8 @@
-# Makefile.in generated by automake 1.9.3 from Makefile.am.
+# Makefile.in generated by automake 1.9.5 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004  Free Software Foundation, Inc.
+# 2003, 2004, 2005  Free Software Foundation, Inc.
 # This Makefile.in is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
@@ -311,7 +311,13 @@
 #     (which will cause the Makefiles to be regenerated when you run `make');
 # (2) otherwise, pass the desired values on the `make' command line.
 $(RECURSIVE_TARGETS):
-	@set fnord $$MAKEFLAGS; amf=$$2; \
+	@failcom='exit 1'; \
+	for f in x $$MAKEFLAGS; do \
+	  case $$f in \
+	    *=* | --[!k]*);; \
+	    *k*) failcom='fail=yes';; \
+	  esac; \
+	done; \
 	dot_seen=no; \
 	target=`echo $@ | sed s/-recursive//`; \
 	list='$(SUBDIRS)'; for subdir in $$list; do \
@@ -323,7 +329,7 @@
 	    local_target="$$target"; \
 	  fi; \
 	  (cd $$subdir && $(MAKE) $(AM_MAKEFLAGS) $$local_target) \
-	   || case "$$amf" in *=*) exit 1;; *k*) fail=yes;; *) exit 1;; esac; \
+	  || eval $$failcom; \
 	done; \
 	if test "$$dot_seen" = "no"; then \
 	  $(MAKE) $(AM_MAKEFLAGS) "$$target-am" || exit 1; \
@@ -331,7 +337,13 @@
 
 mostlyclean-recursive clean-recursive distclean-recursive \
 maintainer-clean-recursive:
-	@set fnord $$MAKEFLAGS; amf=$$2; \
+	@failcom='exit 1'; \
+	for f in x $$MAKEFLAGS; do \
+	  case $$f in \
+	    *=* | --[!k]*);; \
+	    *k*) failcom='fail=yes';; \
+	  esac; \
+	done; \
 	dot_seen=no; \
 	case "$@" in \
 	  distclean-* | maintainer-clean-*) list='$(DIST_SUBDIRS)' ;; \
@@ -352,7 +364,7 @@
 	    local_target="$$target"; \
 	  fi; \
 	  (cd $$subdir && $(MAKE) $(AM_MAKEFLAGS) $$local_target) \
-	   || case "$$amf" in *=*) exit 1;; *k*) fail=yes;; *) exit 1;; esac; \
+	  || eval $$failcom; \
 	done && test -z "$$fail"
 tags-recursive:
 	list='$(SUBDIRS)'; for subdir in $$list; do \
diff -urN -X tar-1.15.1-filter -x build tar-1.15.1-orig/aclocal.m4 tar-1.15.1/aclocal.m4
--- tar-1.15.1-orig/aclocal.m4	2004-12-21 06:29:44.000000000 -0700
+++ tar-1.15.1/aclocal.m4	2005-08-13 13:12:03.000000000 -0600
@@ -1,7 +1,7 @@
-# generated automatically by aclocal 1.9.3 -*- Autoconf -*-
+# generated automatically by aclocal 1.9.5 -*- Autoconf -*-
 
-# Copyright (C) 1996, 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2004
-# Free Software Foundation, Inc.
+# Copyright (C) 1996, 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2004,
+# 2005  Free Software Foundation, Inc.
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
@@ -11,23 +11,11 @@
 # even the implied warranty of MERCHANTABILITY or FITNESS FOR A
 # PARTICULAR PURPOSE.
 
-#                                                        -*- Autoconf -*-
-# Copyright (C) 2002, 2003  Free Software Foundation, Inc.
-# Generated from amversion.in; do not edit by hand.
-
-# This program is free software; you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation; either version 2, or (at your option)
-# any later version.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-
-# You should have received a copy of the GNU General Public License
-# along with this program; if not, write to the Free Software
-# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+# Copyright (C) 2002, 2003, 2005  Free Software Foundation, Inc.
+#
+# This file is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
 
 # AM_AUTOMAKE_VERSION(VERSION)
 # ----------------------------
@@ -40,26 +28,15 @@
 # Call AM_AUTOMAKE_VERSION so it can be traced.
 # This function is AC_REQUIREd by AC_INIT_AUTOMAKE.
 AC_DEFUN([AM_SET_CURRENT_AUTOMAKE_VERSION],
-	 [AM_AUTOMAKE_VERSION([1.9.3])])
-
-# AM_AUX_DIR_EXPAND
-
-# Copyright (C) 2001, 2003 Free Software Foundation, Inc.
+	 [AM_AUTOMAKE_VERSION([1.9.5])])
 
-# This program is free software; you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation; either version 2, or (at your option)
-# any later version.
+# AM_AUX_DIR_EXPAND                                         -*- Autoconf -*-
 
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-
-# You should have received a copy of the GNU General Public License
-# along with this program; if not, write to the Free Software
-# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-# 02111-1307, USA.
+# Copyright (C) 2001, 2003, 2005  Free Software Foundation, Inc.
+#
+# This file is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
 
 # For projects using AC_CONFIG_AUX_DIR([foo]), Autoconf sets
 # $ac_aux_dir to `$srcdir/foo'.  In other projects, it is set to
@@ -106,26 +83,16 @@
 am_aux_dir=`cd $ac_aux_dir && pwd`
 ])
 
-# AM_CONDITIONAL                                              -*- Autoconf -*-
-
-# Copyright (C) 1997, 2000, 2001, 2003, 2004 Free Software Foundation, Inc.
+# AM_CONDITIONAL                                            -*- Autoconf -*-
 
-# This program is free software; you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation; either version 2, or (at your option)
-# any later version.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-
-# You should have received a copy of the GNU General Public License
-# along with this program; if not, write to the Free Software
-# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-# 02111-1307, USA.
+# Copyright (C) 1997, 2000, 2001, 2003, 2004, 2005
+# Free Software Foundation, Inc.
+#
+# This file is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
 
-# serial 6
+# serial 7
 
 # AM_CONDITIONAL(NAME, SHELL-CONDITION)
 # -------------------------------------
@@ -149,26 +116,15 @@
 Usually this means the macro was only invoked conditionally.]])
 fi])])
 
-# serial 7						-*- Autoconf -*-
 
-# Copyright (C) 1999, 2000, 2001, 2002, 2003, 2004
+# Copyright (C) 1999, 2000, 2001, 2002, 2003, 2004, 2005
 # Free Software Foundation, Inc.
+#
+# This file is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
 
-# This program is free software; you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation; either version 2, or (at your option)
-# any later version.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-
-# You should have received a copy of the GNU General Public License
-# along with this program; if not, write to the Free Software
-# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-# 02111-1307, USA.
-
+# serial 8
 
 # There are a few dirty hacks below to avoid letting `AC_PROG_CC' be
 # written in clear, in which case automake, when reading aclocal.m4,
@@ -177,7 +133,6 @@
 # CC etc. in the Makefile, will ask for an AC_PROG_CC use...
 
 
-
 # _AM_DEPENDENCIES(NAME)
 # ----------------------
 # See how the compiler implements dependency checking.
@@ -317,27 +272,16 @@
 AC_SUBST([AMDEPBACKSLASH])
 ])
 
-# Generate code to set up dependency tracking.   -*- Autoconf -*-
+# Generate code to set up dependency tracking.              -*- Autoconf -*-
 
-# Copyright (C) 1999, 2000, 2001, 2002, 2003, 2004
-#   Free Software Foundation, Inc.
-
-# This program is free software; you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation; either version 2, or (at your option)
-# any later version.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-
-# You should have received a copy of the GNU General Public License
-# along with this program; if not, write to the Free Software
-# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-# 02111-1307, USA.
+# Copyright (C) 1999, 2000, 2001, 2002, 2003, 2004, 2005
+# Free Software Foundation, Inc.
+#
+# This file is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
 
-#serial 2
+#serial 3
 
 # _AM_OUTPUT_DEPENDENCY_COMMANDS
 # ------------------------------
@@ -396,30 +340,19 @@
      [AMDEP_TRUE="$AMDEP_TRUE" ac_aux_dir="$ac_aux_dir"])
 ])
 
-# Do all the work for Automake.                            -*- Autoconf -*-
+# Do all the work for Automake.                             -*- Autoconf -*-
 
-# This macro actually does too much some checks are only needed if
-# your package does certain things.  But this isn't really a big deal.
-
-# Copyright (C) 1996, 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2004
+# Copyright (C) 1996, 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2004, 2005
 # Free Software Foundation, Inc.
+#
+# This file is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
 
-# This program is free software; you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation; either version 2, or (at your option)
-# any later version.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-
-# You should have received a copy of the GNU General Public License
-# along with this program; if not, write to the Free Software
-# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-# 02111-1307, USA.
+# serial 12
 
-# serial 11
+# This macro actually does too much.  Some checks are only needed if
+# your package does certain things.  But this isn't really a big deal.
 
 # AM_INIT_AUTOMAKE(PACKAGE, VERSION, [NO-DEFINE])
 # AM_INIT_AUTOMAKE([OPTIONS])
@@ -521,51 +454,27 @@
 done
 echo "timestamp for $1" >`AS_DIRNAME([$1])`/stamp-h[]$_am_stamp_count])
 
+# Copyright (C) 2001, 2003, 2005  Free Software Foundation, Inc.
+#
+# This file is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
+
 # AM_PROG_INSTALL_SH
 # ------------------
 # Define $install_sh.
-
-# Copyright (C) 2001, 2003 Free Software Foundation, Inc.
-
-# This program is free software; you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation; either version 2, or (at your option)
-# any later version.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-
-# You should have received a copy of the GNU General Public License
-# along with this program; if not, write to the Free Software
-# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-# 02111-1307, USA.
-
 AC_DEFUN([AM_PROG_INSTALL_SH],
 [AC_REQUIRE([AM_AUX_DIR_EXPAND])dnl
 install_sh=${install_sh-"$am_aux_dir/install-sh"}
 AC_SUBST(install_sh)])
 
-#                                                          -*- Autoconf -*-
-# Copyright (C) 2003  Free Software Foundation, Inc.
-
-# This program is free software; you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation; either version 2, or (at your option)
-# any later version.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-
-# You should have received a copy of the GNU General Public License
-# along with this program; if not, write to the Free Software
-# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-# 02111-1307, USA.
+# Copyright (C) 2003, 2005  Free Software Foundation, Inc.
+#
+# This file is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
 
-# serial 1
+# serial 2
 
 # Check whether the underlying file-system supports filenames
 # with a leading dot.  For instance MS-DOS doesn't.
@@ -580,26 +489,15 @@
 rmdir .tst 2>/dev/null
 AC_SUBST([am__leading_dot])])
 
-# Check to see how 'make' treats includes.	-*- Autoconf -*-
-
-# Copyright (C) 2001, 2002, 2003 Free Software Foundation, Inc.
-
-# This program is free software; you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation; either version 2, or (at your option)
-# any later version.
+# Check to see how 'make' treats includes.	            -*- Autoconf -*-
 
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-
-# You should have received a copy of the GNU General Public License
-# along with this program; if not, write to the Free Software
-# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-# 02111-1307, USA.
+# Copyright (C) 2001, 2002, 2003, 2005  Free Software Foundation, Inc.
+#
+# This file is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
 
-# serial 2
+# serial 3
 
 # AM_MAKE_INCLUDE()
 # -----------------
@@ -643,27 +541,16 @@
 rm -f confinc confmf
 ])
 
-#  -*- Autoconf -*-
-
-
-# Copyright (C) 1997, 1999, 2000, 2001, 2003 Free Software Foundation, Inc.
+# Fake the existence of programs that GNU maintainers use.  -*- Autoconf -*-
 
-# This program is free software; you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation; either version 2, or (at your option)
-# any later version.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-
-# You should have received a copy of the GNU General Public License
-# along with this program; if not, write to the Free Software
-# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-# 02111-1307, USA.
+# Copyright (C) 1997, 1999, 2000, 2001, 2003, 2005
+# Free Software Foundation, Inc.
+#
+# This file is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
 
-# serial 3
+# serial 4
 
 # AM_MISSING_PROG(NAME, PROGRAM)
 # ------------------------------
@@ -689,27 +576,16 @@
 fi
 ])
 
+# Copyright (C) 2003, 2004, 2005  Free Software Foundation, Inc.
+#
+# This file is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
+
 # AM_PROG_MKDIR_P
 # ---------------
 # Check whether `mkdir -p' is supported, fallback to mkinstalldirs otherwise.
-
-# Copyright (C) 2003, 2004 Free Software Foundation, Inc.
-
-# This program is free software; you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation; either version 2, or (at your option)
-# any later version.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-
-# You should have received a copy of the GNU General Public License
-# along with this program; if not, write to the Free Software
-# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-# 02111-1307, USA.
-
+#
 # Automake 1.8 used `mkdir -m 0755 -p --' to ensure that directories
 # created by `make install' are always world readable, even if the
 # installer happens to have an overly restrictive umask (e.g. 077).
@@ -763,26 +639,15 @@
 fi
 AC_SUBST([mkdir_p])])
 
-# Helper functions for option handling.                    -*- Autoconf -*-
-
-# Copyright (C) 2001, 2002, 2003  Free Software Foundation, Inc.
-
-# This program is free software; you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation; either version 2, or (at your option)
-# any later version.
+# Helper functions for option handling.                     -*- Autoconf -*-
 
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-
-# You should have received a copy of the GNU General Public License
-# along with this program; if not, write to the Free Software
-# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-# 02111-1307, USA.
+# Copyright (C) 2001, 2002, 2003, 2005  Free Software Foundation, Inc.
+#
+# This file is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
 
-# serial 2
+# serial 3
 
 # _AM_MANGLE_OPTION(NAME)
 # -----------------------
@@ -807,28 +672,16 @@
 AC_DEFUN([_AM_IF_OPTION],
 [m4_ifset(_AM_MANGLE_OPTION([$1]), [$2], [$3])])
 
-#
-# Check to make sure that the build environment is sane.
-#
+# Check to make sure that the build environment is sane.    -*- Autoconf -*-
 
-# Copyright (C) 1996, 1997, 2000, 2001, 2003 Free Software Foundation, Inc.
-
-# This program is free software; you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation; either version 2, or (at your option)
-# any later version.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-
-# You should have received a copy of the GNU General Public License
-# along with this program; if not, write to the Free Software
-# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-# 02111-1307, USA.
+# Copyright (C) 1996, 1997, 2000, 2001, 2003, 2005
+# Free Software Foundation, Inc.
+#
+# This file is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
 
-# serial 3
+# serial 4
 
 # AM_SANITY_CHECK
 # ---------------
@@ -871,25 +724,14 @@
 fi
 AC_MSG_RESULT(yes)])
 
-# AM_PROG_INSTALL_STRIP
-
-# Copyright (C) 2001, 2003 Free Software Foundation, Inc.
-
-# This program is free software; you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation; either version 2, or (at your option)
-# any later version.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-
-# You should have received a copy of the GNU General Public License
-# along with this program; if not, write to the Free Software
-# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-# 02111-1307, USA.
+# Copyright (C) 2001, 2003, 2005  Free Software Foundation, Inc.
+#
+# This file is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
 
+# AM_PROG_INSTALL_STRIP
+# ---------------------
 # One issue with vendor `install' (even GNU) is that you can't
 # specify the program used to strip binaries.  This is especially
 # annoying in cross-compiling environments, where the build's strip
@@ -912,25 +754,13 @@
 
 # Check how to create a tarball.                            -*- Autoconf -*-
 
-# Copyright (C) 2004  Free Software Foundation, Inc.
-
-# This program is free software; you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation; either version 2, or (at your option)
-# any later version.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-
-# You should have received a copy of the GNU General Public License
-# along with this program; if not, write to the Free Software
-# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-# 02111-1307, USA.
-
-# serial 1
+# Copyright (C) 2004, 2005  Free Software Foundation, Inc.
+#
+# This file is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
 
+# serial 2
 
 # _AM_PROG_TAR(FORMAT)
 # --------------------
diff -urN -X tar-1.15.1-filter -x build tar-1.15.1-orig/configure tar-1.15.1/configure
--- tar-1.15.1-orig/configure	2004-12-21 06:30:30.000000000 -0700
+++ tar-1.15.1/configure	2005-08-13 13:12:37.000000000 -0600
@@ -21928,7 +21928,7 @@
 fi
 echo "$as_me:$LINENO: result: $pu_cv_header_rmt" >&5
 echo "${ECHO_T}$pu_cv_header_rmt" >&6
-      test $pu_cv_header_rmt = yes && PU_RMT_PROG='rmt'
+      test $pu_cv_header_rmt = yes && PU_RMT_PROG='rmt$(EXEEXT)'
 
     fi
   }
diff -urN -X tar-1.15.1-filter -x build tar-1.15.1-orig/doc/Makefile.in tar-1.15.1/doc/Makefile.in
--- tar-1.15.1-orig/doc/Makefile.in	2004-12-21 06:30:58.000000000 -0700
+++ tar-1.15.1/doc/Makefile.in	2005-08-13 13:12:28.000000000 -0600
@@ -1,8 +1,8 @@
-# Makefile.in generated by automake 1.9.3 from Makefile.am.
+# Makefile.in generated by automake 1.9.5 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004  Free Software Foundation, Inc.
+# 2003, 2004, 2005  Free Software Foundation, Inc.
 # This Makefile.in is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
@@ -364,7 +364,7 @@
 	$(DVIPS) -o $@ $<
 
 uninstall-info-am:
-	$(PRE_UNINSTALL)
+	@$(PRE_UNINSTALL)
 	@if (install-info --version && \
 	     install-info --version 2>&1 | sed 1q | grep -i -v debian) >/dev/null 2>&1; then \
 	  list='$(INFO_DEPS)'; \
@@ -380,7 +380,7 @@
 	  relfile=`echo "$$file" | sed 's|^.*/||'`; \
 	  relfile_i=`echo "$$relfile" | sed 's|\.info$$||;s|$$|.i|'`; \
 	  (if cd "$(DESTDIR)$(infodir)"; then \
-	     echo " rm -f $$relfile $$relfile-[0-9] $$relfile-[0-9][0-9] $$relfile_i[0-9] $$relfile_i[0-9][0-9])"; \
+	     echo " cd '$(DESTDIR)$(infodir)' && rm -f $$relfile $$relfile-[0-9] $$relfile-[0-9][0-9] $$relfile_i[0-9] $$relfile_i[0-9][0-9]"; \
 	     rm -f $$relfile $$relfile-[0-9] $$relfile-[0-9][0-9] $$relfile_i[0-9] $$relfile_i[0-9][0-9]; \
 	   else :; fi); \
 	done
diff -urN -X tar-1.15.1-filter -x build tar-1.15.1-orig/lib/Makefile.in tar-1.15.1/lib/Makefile.in
--- tar-1.15.1-orig/lib/Makefile.in	2004-12-21 06:31:00.000000000 -0700
+++ tar-1.15.1/lib/Makefile.in	2005-08-13 13:12:30.000000000 -0600
@@ -1,8 +1,8 @@
-# Makefile.in generated by automake 1.9.3 from Makefile.am.
+# Makefile.in generated by automake 1.9.5 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004  Free Software Foundation, Inc.
+# 2003, 2004, 2005  Free Software Foundation, Inc.
 # This Makefile.in is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
diff -urN -X tar-1.15.1-filter -x build tar-1.15.1-orig/lib/localedir.h tar-1.15.1/lib/localedir.h
--- tar-1.15.1-orig/lib/localedir.h	2004-12-21 07:01:12.000000000 -0700
+++ tar-1.15.1/lib/localedir.h	1969-12-31 17:00:00.000000000 -0700
@@ -1,4 +0,0 @@
-#define LOCALEDIR "/usr/share/locale"
-#ifndef DEFAULT_RMT_COMMAND
-# define DEFAULT_RMT_COMMAND "/etc/rmt"
-#endif
diff -urN -X tar-1.15.1-filter -x build tar-1.15.1-orig/lib/rmt.h tar-1.15.1/lib/rmt.h
--- tar-1.15.1-orig/lib/rmt.h	2004-09-06 07:49:41.000000000 -0600
+++ tar-1.15.1/lib/rmt.h	2005-08-15 06:50:24.000000000 -0600
@@ -51,7 +51,7 @@
 
 #define rmtopen(dev_name, oflag, mode, command) \
   (_remdev (dev_name) ? rmt_open__ (dev_name, oflag, __REM_BIAS, command) \
-   : open (dev_name, oflag, mode))
+   : open (dev_name, oflag | O_BINARY, mode))
 
 #define rmtaccess(dev_name, amode) \
   (_remdev (dev_name) ? 0 : access (dev_name, amode))
@@ -59,10 +59,11 @@
 #define rmtstat(dev_name, buffer) \
   (_remdev (dev_name) ? (errno = EOPNOTSUPP), -1 : stat (dev_name, buffer))
 
+/* creat can create inadvertent text files when binary is wanted.  Use open */
 #define rmtcreat(dev_name, mode, command) \
    (_remdev (dev_name) \
     ? rmt_open__ (dev_name, 1 | O_CREAT, __REM_BIAS, command) \
-    : creat (dev_name, mode))
+    : open (dev_name, O_WRONLY | O_CREAT | O_TRUNC | O_BINARY, mode))
 
 #define rmtlstat(dev_name, muffer) \
   (_remdev (dev_name) ? (errno = EOPNOTSUPP), -1 : lstat (dev_name, buffer))
diff -urN -X tar-1.15.1-filter -x build tar-1.15.1-orig/m4/rmt.m4 tar-1.15.1/m4/rmt.m4
--- tar-1.15.1-orig/m4/rmt.m4	2004-09-06 07:49:41.000000000 -0600
+++ tar-1.15.1/m4/rmt.m4	2005-08-13 13:11:38.000000000 -0600
@@ -10,7 +10,7 @@
 #include <sys/socket.h>],
       pu_cv_header_rmt=yes,
       pu_cv_header_rmt=no)])
-      test $pu_cv_header_rmt = yes && PU_RMT_PROG='rmt'
+      test $pu_cv_header_rmt = yes && PU_RMT_PROG='rmt$(EXEEXT)'
       AC_SUBST(PU_RMT_PROG)
     fi
   }
diff -urN -X tar-1.15.1-filter -x build tar-1.15.1-orig/rmt/Makefile.in tar-1.15.1/rmt/Makefile.in
--- tar-1.15.1-orig/rmt/Makefile.in	2004-12-21 06:31:01.000000000 -0700
+++ tar-1.15.1/rmt/Makefile.in	2005-08-13 13:12:30.000000000 -0600
@@ -1,8 +1,8 @@
-# Makefile.in generated by automake 1.9.3 from Makefile.am.
+# Makefile.in generated by automake 1.9.5 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004  Free Software Foundation, Inc.
+# 2003, 2004, 2005  Free Software Foundation, Inc.
 # This Makefile.in is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
@@ -304,7 +304,8 @@
 	  f=`echo "$$p" | \
 	     sed 's,^.*/,,;s/$(EXEEXT)$$//;$(transform);s/$$/$(EXEEXT)/'`; \
 	  for opt in --help --version; do \
-	    if "$(DESTDIR)$(rmtdir)/$$f" $$opt > c$${pid}_.out 2> c$${pid}_.err \
+	    if "$(DESTDIR)$(rmtdir)/$$f" $$opt >c$${pid}_.out \
+	         2>c$${pid}_.err </dev/null \
 		 && test -n "`cat c$${pid}_.out`" \
 		 && test -z "`cat c$${pid}_.err`"; then :; \
 	    else echo "$$f does not support $$opt" 1>&2; bad=1; fi; \
diff -urN -X tar-1.15.1-filter -x build tar-1.15.1-orig/rmt/rmt.c tar-1.15.1/rmt/rmt.c
--- tar-1.15.1-orig/rmt/rmt.c	2004-12-21 01:06:26.000000000 -0700
+++ tar-1.15.1/rmt/rmt.c	2005-08-13 20:14:25.000000000 -0600
@@ -344,7 +344,8 @@
 	if (tape >= 0)
 	  close (tape);
 
-	tape = open (device_string, decode_oflag (oflag_string), MODE_RW);
+	tape = open (device_string, decode_oflag (oflag_string) | O_BINARY,
+		     MODE_RW);
 	if (tape < 0)
 	  goto ioerror;
 	goto respond;
diff -urN -X tar-1.15.1-filter -x build tar-1.15.1-orig/scripts/Makefile.in tar-1.15.1/scripts/Makefile.in
--- tar-1.15.1-orig/scripts/Makefile.in	2004-12-21 06:31:01.000000000 -0700
+++ tar-1.15.1/scripts/Makefile.in	2005-08-13 13:12:31.000000000 -0600
@@ -1,8 +1,8 @@
-# Makefile.in generated by automake 1.9.3 from Makefile.am.
+# Makefile.in generated by automake 1.9.5 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004  Free Software Foundation, Inc.
+# 2003, 2004, 2005  Free Software Foundation, Inc.
 # This Makefile.in is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
@@ -299,7 +299,8 @@
 	  esac; \
 	  f=`echo "$$p" | sed 's,^.*/,,;$(transform)'`; \
 	  for opt in --help --version; do \
-	    if "$(DESTDIR)$(libexecdir)/$$f" $$opt > c$${pid}_.out 2> c$${pid}_.err \
+	    if "$(DESTDIR)$(libexecdir)/$$f" $$opt >c$${pid}_.out \
+	         2>c$${pid}_.err </dev/null \
 		 && test -n "`cat c$${pid}_.out`" \
 		 && test -z "`cat c$${pid}_.err`"; then :; \
 	    else echo "$$f does not support $$opt" 1>&2; bad=1; fi; \
@@ -332,7 +333,8 @@
 	  esac; \
 	  f=`echo "$$p" | sed 's,^.*/,,;$(transform)'`; \
 	  for opt in --help --version; do \
-	    if "$(DESTDIR)$(sbindir)/$$f" $$opt > c$${pid}_.out 2> c$${pid}_.err \
+	    if "$(DESTDIR)$(sbindir)/$$f" $$opt >c$${pid}_.out \
+	         2>c$${pid}_.err </dev/null \
 		 && test -n "`cat c$${pid}_.out`" \
 		 && test -z "`cat c$${pid}_.err`"; then :; \
 	    else echo "$$f does not support $$opt" 1>&2; bad=1; fi; \
diff -urN -X tar-1.15.1-filter -x build tar-1.15.1-orig/src/Makefile.in tar-1.15.1/src/Makefile.in
--- tar-1.15.1-orig/src/Makefile.in	2004-12-21 06:31:02.000000000 -0700
+++ tar-1.15.1/src/Makefile.in	2005-08-13 13:12:32.000000000 -0600
@@ -1,8 +1,8 @@
-# Makefile.in generated by automake 1.9.3 from Makefile.am.
+# Makefile.in generated by automake 1.9.5 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004  Free Software Foundation, Inc.
+# 2003, 2004, 2005  Free Software Foundation, Inc.
 # This Makefile.in is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
@@ -333,7 +333,8 @@
 	  f=`echo "$$p" | \
 	     sed 's,^.*/,,;s/$(EXEEXT)$$//;$(transform);s/$$/$(EXEEXT)/'`; \
 	  for opt in --help --version; do \
-	    if "$(DESTDIR)$(bindir)/$$f" $$opt > c$${pid}_.out 2> c$${pid}_.err \
+	    if "$(DESTDIR)$(bindir)/$$f" $$opt >c$${pid}_.out \
+	         2>c$${pid}_.err </dev/null \
 		 && test -n "`cat c$${pid}_.out`" \
 		 && test -z "`cat c$${pid}_.err`"; then :; \
 	    else echo "$$f does not support $$opt" 1>&2; bad=1; fi; \
diff -urN -X tar-1.15.1-filter -x build tar-1.15.1-orig/src/buffer.c tar-1.15.1/src/buffer.c
--- tar-1.15.1-orig/src/buffer.c	2004-12-21 08:09:24.000000000 -0700
+++ tar-1.15.1/src/buffer.c	2006-03-13 07:00:27.347299800 -0700
@@ -377,7 +377,7 @@
 
   if (index_file_name)
     {
-      stdlis = fopen (index_file_name, "w");
+      stdlis = fopen (index_file_name, "wb");
       if (! stdlis)
 	open_error (index_file_name);
     }
@@ -1120,7 +1120,7 @@
 void
 closeout_volume_number (void)
 {
-  FILE *file = fopen (volno_file_option, "w");
+  FILE *file = fopen (volno_file_option, "wb");
 
   if (file)
     {
@@ -1145,7 +1145,7 @@
 
   if (!read_file && !info_script_option)
     /* FIXME: if fopen is used, it will never be closed.  */
-    read_file = archive == STDIN_FILENO ? fopen (TTY_NAME, "r") : stdin;
+    read_file = archive == STDIN_FILENO ? fopen (TTY_NAME, "rb") : stdin;
 
   if (now_verifying)
     return false;
diff -urN -X tar-1.15.1-filter -x build tar-1.15.1-orig/src/create.c tar-1.15.1/src/create.c
--- tar-1.15.1-orig/src/create.c	2004-10-04 03:21:31.000000000 -0600
+++ tar-1.15.1/src/create.c	2005-08-13 20:19:29.000000000 -0600
@@ -945,7 +945,7 @@
   strcpy (tagpath, dirname);
   strcat (tagpath, tagname);
 
-  fd = open (tagpath, O_RDONLY);
+  fd = open (tagpath, O_RDONLY | O_BINARY);
   if (fd >= 0)
     {
       static char tagbuf[CACHEDIR_SIGNATURE_SIZE];
diff -urN -X tar-1.15.1-filter -x build tar-1.15.1-orig/src/delete.c tar-1.15.1/src/delete.c
--- tar-1.15.1-orig/src/delete.c	2004-12-17 07:40:39.000000000 -0700
+++ tar-1.15.1/src/delete.c	2005-08-15 07:29:28.000000000 -0600
@@ -162,6 +162,8 @@
   name_gather ();
   open_archive (ACCESS_UPDATE);
   acting_as_filter = strcmp (archive_name_array[0], "-") == 0;
+  if (acting_as_filter && ! isatty (STDOUT_FILENO))
+    setmode (STDOUT_FILENO, O_BINARY);
 
   do
     {
diff -urN -X tar-1.15.1-filter -x build tar-1.15.1-orig/src/extract.c tar-1.15.1/src/extract.c
--- tar-1.15.1-orig/src/extract.c	2004-12-21 02:55:12.000000000 -0700
+++ tar-1.15.1/src/extract.c	2005-08-13 20:21:02.000000000 -0600
@@ -833,7 +833,8 @@
 	     will be replaced after other extraction is done.  */
 	  struct stat st;
 
-	  while (fd = open (file_name, O_WRONLY | O_CREAT | O_EXCL, 0),
+	  while (fd = open (file_name, O_WRONLY | O_CREAT | O_EXCL | O_BINARY,
+			    0),
 		 fd < 0)
 	    if (! maybe_recoverable (file_name, &interdir_made))
 	      break;
@@ -1149,8 +1150,10 @@
 	     don't create a symlink, as the placeholder was probably
 	     removed by a later extraction.  */
 	  if (lstat (source, &st) == 0
+#ifndef __CYGWIN__ /* These tests are unsafe on cygwin on Win9x.  */
 	      && st.st_dev == ds->dev
 	      && st.st_ino == ds->ino
+#endif /* __CYGWIN__ */
 	      && st.st_mtime == ds->mtime)
 	    {
 	      /* Unlink the placeholder, then create a hard link if possible,
diff -urN -X tar-1.15.1-filter -x build tar-1.15.1-orig/src/incremen.c tar-1.15.1/src/incremen.c
--- tar-1.15.1-orig/src/incremen.c	2004-09-06 05:30:42.000000000 -0600
+++ tar-1.15.1/src/incremen.c	2006-03-13 07:00:27.362926400 -0700
@@ -325,14 +325,14 @@
   /* Open the file for both read and write.  That way, we can write
      it later without having to reopen it, and don't have to worry if
      we chdir in the meantime.  */
-  fd = open (listed_incremental_option, O_RDWR | O_CREAT, MODE_RW);
+  fd = open (listed_incremental_option, O_RDWR | O_CREAT | O_BINARY, MODE_RW);
   if (fd < 0)
     {
       open_error (listed_incremental_option);
       return;
     }
 
-  fp = fdopen (fd, "r+");
+  fp = fdopen (fd, "rb+");
   if (! fp)
     {
       open_error (listed_incremental_option);
@@ -371,7 +371,14 @@
 	  lineno++;
 
 	  if (buf[n - 1] == '\n')
-	    buf[n - 1] = '\0';
+	    {
+	      buf[n - 1] = '\0';
+	      /* Cygwin hack - older tars created incremental files with \r\n
+		 line endings, so strip the \r.  This breaks on managed mount
+		 on directories with a trailing \r, oh well.  */
+	      if (buf[n - 2] == '\r')
+		buf[n - 2] = '\0';
+	    }
 
 	  errno = 0;
 	  dev = u = strtoul (strp, &ebuf, 10);
@@ -386,15 +393,21 @@
 	  strp = ebuf;
 
 	  errno = 0;
+#ifdef __CYGWIN_USE_BIG_TYPES__
+	  ino = strtoull (strp, &ebuf, 10);
+#else
 	  ino = u = strtoul (strp, &ebuf, 10);
-	  if (strp == ebuf || (u == 0 && errno == EINVAL))
+#endif
+	  if (strp == ebuf || (ino == 0 && errno == EINVAL))
 	    ERROR ((0, 0, "%s:%ld: %s",
 		    quotearg_colon (listed_incremental_option), lineno,
 		    _("Invalid inode number")));
+#ifndef __CYGWIN_USE_BIG_TYPES__
 	  else if (ino != u || (u == -1 && errno == ERANGE))
 	    ERROR ((0, 0, "%s:%ld: %s",
 		    quotearg_colon (listed_incremental_option), lineno,
 		    _("Inode number out of range")));
+#endif
 	  strp = ebuf;
 
 	  strp++;
@@ -421,10 +434,17 @@
     {
       int e;
       char *str = quote_copy_string (directory->name);
+#ifdef __CYGWIN_USE_BIG_TYPES__
+      fprintf (fp, "+%lu %llu %s\n" + ! directory->nfs,
+	       (unsigned long) directory->device_number,
+	       (unsigned long long) directory->inode_number,
+	       str ? str : directory->name);
+#else
       fprintf (fp, "+%lu %lu %s\n" + ! directory->nfs,
 	       (unsigned long) directory->device_number,
 	       (unsigned long) directory->inode_number,
 	       str ? str : directory->name);
+#endif
       e = errno;
       if (str)
 	free (str);
diff -urN -X tar-1.15.1-filter -x build tar-1.15.1-orig/src/names.c tar-1.15.1/src/names.c
--- tar-1.15.1-orig/src/names.c	2004-09-06 05:30:54.000000000 -0600
+++ tar-1.15.1/src/names.c	2005-08-18 06:44:03.000000000 -0600
@@ -241,7 +241,14 @@
 	  request_stdin ("-T");
 	  name_file = stdin;
 	}
-      else if (name_file = fopen (files_from_option, "r"), !name_file)
+      /* If filename_terminator is '\0', open in binary mode.  Otherwise,
+	 we would like to open in mount mode (so that binary managed mounts
+	 can have filenames ending in \r, while text mounts strip all \r\n
+	 line endings), but for backwards compatibility to earlier cygwin
+	 releases we force text mode. */
+      else if (name_file = fopen (files_from_option,
+				  filename_terminator ? "rt" : "rb"),
+	       !name_file)
 	open_fatal (files_from_option);
     }
 }
diff -urN -X tar-1.15.1-filter -x build tar-1.15.1-orig/src/system.c tar-1.15.1/src/system.c
--- tar-1.15.1-orig/src/system.c	2004-09-06 05:31:00.000000000 -0600
+++ tar-1.15.1/src/system.c	2005-08-15 07:01:31.000000000 -0600
@@ -370,7 +370,8 @@
       /* We don't need a grandchild tar.  Open the archive and launch the
 	 compressor.  */
 
-      archive = creat (archive_name_array[0], MODE_RW);
+      archive = open (archive_name_array[0],
+		      O_WRONLY | O_CREAT | O_TRUNC | O_BINARY, MODE_RW);
       if (archive < 0)
 	{
 	  int saved_errno = errno;
@@ -412,7 +413,11 @@
   xclose (child_pipe[PWRITE]);
 
   if (strcmp (archive_name_array[0], "-") == 0)
-    archive = STDOUT_FILENO;
+    {
+      archive = STDOUT_FILENO;
+      if (! isatty (STDOUT_FILENO))
+	setmode (STDOUT_FILENO, O_BINARY);
+    }
   else
     {
       archive = rmtcreat (archive_name_array[0], MODE_RW, rsh_command_option);
diff -urN -X tar-1.15.1-filter -x build tar-1.15.1-orig/src/tar.c tar-1.15.1/src/tar.c
--- tar-1.15.1-orig/src/tar.c	2004-12-21 07:11:26.000000000 -0700
+++ tar-1.15.1/src/tar.c	2005-12-21 06:12:26.000000000 -0700
@@ -1,7 +1,7 @@
 /* A tar (tape archiver) program.
 
    Copyright (C) 1988, 1992, 1993, 1994, 1995, 1996, 1997, 1999, 2000,
-   2001, 2003, 2004 Free Software Foundation, Inc.
+   2001, 2003, 2004, 2005 Free Software Foundation, Inc.
 
    Written by John Gilmore, starting 1985-08-25.
 
@@ -1530,8 +1530,11 @@
     {
       if (multi_volume_option)
 	USAGE_ERROR ((0, 0, _("Cannot use multi-volume compressed archives")));
-      if (subcommand_option == UPDATE_SUBCOMMAND)
+      if (subcommand_option == UPDATE_SUBCOMMAND
+	  || subcommand_option == APPEND_SUBCOMMAND)
 	USAGE_ERROR ((0, 0, _("Cannot update compressed archives")));
+      if (subcommand_option == CAT_SUBCOMMAND)
+	USAGE_ERROR ((0, 0, _("Cannot concatenate compressed archives")));
     }
 
   /* It is no harm to use --pax-option on non-pax archives in archive
diff -urN -X tar-1.15.1-filter -x build tar-1.15.1-orig/src/xheader.c tar-1.15.1/src/xheader.c
--- tar-1.15.1-orig/src/xheader.c	2004-09-06 05:31:14.000000000 -0600
+++ tar-1.15.1/src/xheader.c	2006-03-13 06:24:51.000000000 -0700
@@ -783,6 +783,32 @@
   xheader_print (xhdr, keyword, sbuf);
 }
 
+static bool
+decode_num (uintmax_t *num, char const *arg, uintmax_t maxval,
+        char const *keyword)
+{
+  uintmax_t u;
+  char *arg_lim;
+
+  if (! (ISDIGIT (*arg)
+     && (errno = 0, u = strtoumax (arg, &arg_lim, 10), !*arg_lim)))
+    {
+      ERROR ((0, 0, _("Malformed extended header: invalid %s=%s"),
+          keyword, arg));
+      return false;
+    }
+
+  if (! (u <= maxval && errno != ERANGE))
+    {
+      ERROR ((0, 0, _("Extended header %s=%s is out of range"),
+        keyword, arg));
+      return false;
+    }
+
+  *num = u;
+  return true;
+}
+
 static void
 dummy_coder (struct tar_stat_info const *st __attribute__ ((unused)),
 	     char const *keyword __attribute__ ((unused)),
@@ -821,7 +847,7 @@
 gid_decoder (struct tar_stat_info *st, char const *arg)
 {
   uintmax_t u;
-  if (xstrtoumax (arg, NULL, 10, &u, "") == LONGINT_OK)
+  if (decode_num (&u, arg, TYPE_MAXIMUM (gid_t), "gid"))
     st->stat.st_gid = u;
 }
 
@@ -903,7 +929,7 @@
 size_decoder (struct tar_stat_info *st, char const *arg)
 {
   uintmax_t u;
-  if (xstrtoumax (arg, NULL, 10, &u, "") == LONGINT_OK)
+  if (decode_num (&u, arg, TYPE_MAXIMUM (off_t), "size"))
     st->archive_file_size = st->stat.st_size = u;
 }
 
@@ -918,7 +944,7 @@
 uid_decoder (struct tar_stat_info *st, char const *arg)
 {
   uintmax_t u;
-  if (xstrtoumax (arg, NULL, 10, &u, "") == LONGINT_OK)
+  if (decode_num (&u, arg, TYPE_MAXIMUM (uid_t), "uid"))
     st->stat.st_uid = u;
 }
 
@@ -946,7 +972,7 @@
 sparse_size_decoder (struct tar_stat_info *st, char const *arg)
 {
   uintmax_t u;
-  if (xstrtoumax (arg, NULL, 10, &u, "") == LONGINT_OK)
+  if (decode_num (&u, arg, TYPE_MAXIMUM (off_t), "GNU.sparse.size"))
     st->stat.st_size = u;
 }
 
@@ -962,10 +988,10 @@
 sparse_numblocks_decoder (struct tar_stat_info *st, char const *arg)
 {
   uintmax_t u;
-  if (xstrtoumax (arg, NULL, 10, &u, "") == LONGINT_OK)
+  if (decode_num (&u, arg, SIZE_MAX, "GNU.sparse.numblocks"))
     {
       st->sparse_map_size = u;
-      st->sparse_map = calloc(st->sparse_map_size, sizeof(st->sparse_map[0]));
+      st->sparse_map = xcalloc (u, sizeof st->sparse_map[0]);
       st->sparse_map_avail = 0;
     }
 }
@@ -982,8 +1008,14 @@
 sparse_offset_decoder (struct tar_stat_info *st, char const *arg)
 {
   uintmax_t u;
-  if (xstrtoumax (arg, NULL, 10, &u, "") == LONGINT_OK)
+  if (decode_num (&u, arg, TYPE_MAXIMUM (off_t), "GNU.sparse.offset"))
+    {
+      if (st->sparse_map_avail < st->sparse_map_size)
     st->sparse_map[st->sparse_map_avail].offset = u;
+      else
+    ERROR ((0, 0, _("Malformed extended header: excess %s=%s"),
+        "GNU.sparse.offset", arg));
+    }
 }
 
 static void
@@ -998,15 +1030,13 @@
 sparse_numbytes_decoder (struct tar_stat_info *st, char const *arg)
 {
   uintmax_t u;
-  if (xstrtoumax (arg, NULL, 10, &u, "") == LONGINT_OK)
+  if (decode_num (&u, arg, SIZE_MAX, "GNU.sparse.numbytes"))
     {
       if (st->sparse_map_avail == st->sparse_map_size)
-	{
-	  st->sparse_map_size *= 2;
-	  st->sparse_map = xrealloc (st->sparse_map,
-				     st->sparse_map_size
-				     * sizeof st->sparse_map[0]);
-	}
+        st->sparse_map = x2nrealloc (st->sparse_map,
+                                    &st->sparse_map_size,
+                                    sizeof st->sparse_map[0]);
+
       st->sparse_map[st->sparse_map_avail++].numbytes = u;
     }
 }
diff -urN -X tar-1.15.1-filter -x build tar-1.15.1-orig/tests/Makefile.am tar-1.15.1/tests/Makefile.am
--- tar-1.15.1-orig/tests/Makefile.am	2004-12-21 03:38:38.000000000 -0700
+++ tar-1.15.1/tests/Makefile.am	2005-08-13 14:21:24.000000000 -0600
@@ -47,6 +47,8 @@
 
 TESTSUITE_AT = \
  testsuite.at\
+ append.at\
+ append01.at\
  comprec.at\
  delete01.at\
  delete02.at\
diff -urN -X tar-1.15.1-filter -x build tar-1.15.1-orig/tests/Makefile.in tar-1.15.1/tests/Makefile.in
--- tar-1.15.1-orig/tests/Makefile.in	2004-12-21 06:31:03.000000000 -0700
+++ tar-1.15.1/tests/Makefile.in	2005-08-13 14:26:49.000000000 -0600
@@ -1,8 +1,8 @@
-# Makefile.in generated by automake 1.9.3 from Makefile.am.
+# Makefile.in generated by automake 1.9.5 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004  Free Software Foundation, Inc.
+# 2003, 2004, 2005  Free Software Foundation, Inc.
 # This Makefile.in is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
@@ -245,6 +245,8 @@
 #
 TESTSUITE_AT = \
  testsuite.at\
+ append.at\
+ append01.at\
  comprec.at\
  delete01.at\
  delete02.at\
diff -urN -X tar-1.15.1-filter -x build tar-1.15.1-orig/tests/append.at tar-1.15.1/tests/append.at
--- tar-1.15.1-orig/tests/append.at	1969-12-31 17:00:00.000000000 -0700
+++ tar-1.15.1/tests/append.at	2005-08-13 14:10:52.000000000 -0600
@@ -0,0 +1,34 @@
+# Process this file with autom4te to create testsuite. -*- Autotest -*-
+
+# Test suite for GNU tar.
+# Copyright (C) 2004 Free Software Foundation, Inc.
+
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 2, or (at your option)
+# any later version.
+
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA
+# 02110-1301, USA.
+
+AT_SETUP([append])
+AT_KEYWORDS([append])
+
+AT_TAR_CHECK([touch file1
+          touch file2
+          tar cf archive file1
+          tar rf archive file2
+          tar tf archive],
+          [0],
+[file1
+file2
+])
+
+AT_CLEANUP
diff -urN -X tar-1.15.1-filter -x build tar-1.15.1-orig/tests/append01.at tar-1.15.1/tests/append01.at
--- tar-1.15.1-orig/tests/append01.at	1969-12-31 17:00:00.000000000 -0700
+++ tar-1.15.1/tests/append01.at	2005-08-13 14:10:52.000000000 -0600
@@ -0,0 +1,48 @@
+# Process this file with autom4te to create testsuite. -*- Autotest -*-
+
+# Test suite for GNU tar.
+# Copyright (C) 2005 Free Software Foundation, Inc.
+
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 2, or (at your option)
+# any later version.
+
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA
+# 02110-1301, USA.
+
+# When decoding a header tar was assigning 0 to oldgnu_header.isextended,
+# which destroyed name prefix. When updating archive, modified prefix
+# could have been written to disk thus producing invalid archive member.
+# Reported by Adye, TJ (Tim), <T.J.Adye@rl.ac.uk> 
+# References:
+#  <7231C15EAC2F164CA6DC326D97493C8B36C25D@exchange35.fed.cclrc.ac.uk>
+#  http://lists.gnu.org/archive/html/bug-tar/2005-02/msg00032.html
+ 
+AT_SETUP([append01])
+AT_KEYWORDS([appending files with long names])
+
+m4_define([PREFIX],[This_is_a_very_long_file_name_prefix_that_is_designed_to_cause_problems_with_appending_long_file_names_that_run_into_a_limit_of_the_ustar_tarX])
+
+AT_TAR_CHECK([
+mkdir PREFIX
+touch PREFIX/file1 PREFIX/file2
+tar cf archive PREFIX/file1
+tar rf archive PREFIX/file2
+tar tf archive
+],
+[0],
+[PREFIX/file1
+PREFIX/file2
+],
+[],[],[],[oldgnu, ustar, posix, gnu])
+
+AT_CLEANUP
+
diff -urN -X tar-1.15.1-filter -x build tar-1.15.1-orig/tests/genfile.c tar-1.15.1/tests/genfile.c
--- tar-1.15.1-orig/tests/genfile.c	2004-09-08 05:50:20.000000000 -0600
+++ tar-1.15.1/tests/genfile.c	2005-08-13 20:25:02.000000000 -0600
@@ -187,7 +187,7 @@
   
   if (file_name)
     {
-      fp = fopen (file_name, "w");
+      fp = fopen (file_name, "wb");
       if (!fp)
 	die (_("cannot open `%s'"), file_name);	
     }
@@ -250,7 +250,7 @@
 
   if (!file_name)
     die (_("cannot generate sparse files on standard output, use --file option"));
-  fd = open (file_name, O_CREAT|O_TRUNC|O_RDWR, 0644);
+  fd = open (file_name, O_CREAT|O_TRUNC|O_RDWR | O_BINARY, 0644);
   if (fd < 0)
     die (_("cannot open `%s'"), file_name);
 
diff -urN -X tar-1.15.1-filter -x build tar-1.15.1-orig/tests/ignfail.at tar-1.15.1/tests/ignfail.at
--- tar-1.15.1-orig/tests/ignfail.at	2004-09-07 12:11:28.000000000 -0600
+++ tar-1.15.1/tests/ignfail.at	2005-08-13 14:01:22.000000000 -0600
@@ -24,7 +24,7 @@
 AT_KEYWORDS([ignfail])
 
 AT_TAR_CHECK([
-if test -w / ; then
+if test -w // ; then
 	# The test is meaningless for super-user.
 	AT_SKIP_TEST
 else
diff -urN -X tar-1.15.1-filter -x build tar-1.15.1-orig/tests/testsuite tar-1.15.1/tests/testsuite
--- tar-1.15.1-orig/tests/testsuite	2004-12-21 06:36:33.000000000 -0700
+++ tar-1.15.1/tests/testsuite	2005-08-13 14:11:06.000000000 -0600
@@ -4460,7 +4460,7 @@
 export TAR_OPTIONS
 rm -rf *
 
-if test -w / ; then
+if test -w // ; then
 	# The test is meaningless for super-user.
 	exit 77
 else
@@ -4505,7 +4505,7 @@
 export TAR_OPTIONS
 rm -rf *
 
-if test -w / ; then
+if test -w // ; then
 	# The test is meaningless for super-user.
 	exit 77
 else
@@ -4580,7 +4580,7 @@
 export TAR_OPTIONS
 rm -rf *
 
-if test -w / ; then
+if test -w // ; then
 	# The test is meaningless for super-user.
 	exit 77
 else
@@ -4625,7 +4625,7 @@
 export TAR_OPTIONS
 rm -rf *
 
-if test -w / ; then
+if test -w // ; then
 	# The test is meaningless for super-user.
 	exit 77
 else
@@ -4700,7 +4700,7 @@
 export TAR_OPTIONS
 rm -rf *
 
-if test -w / ; then
+if test -w // ; then
 	# The test is meaningless for super-user.
 	exit 77
 else
@@ -4745,7 +4745,7 @@
 export TAR_OPTIONS
 rm -rf *
 
-if test -w / ; then
+if test -w // ; then
 	# The test is meaningless for super-user.
 	exit 77
 else
@@ -4820,7 +4820,7 @@
 export TAR_OPTIONS
 rm -rf *
 
-if test -w / ; then
+if test -w // ; then
 	# The test is meaningless for super-user.
 	exit 77
 else
@@ -4865,7 +4865,7 @@
 export TAR_OPTIONS
 rm -rf *
 
-if test -w / ; then
+if test -w // ; then
 	# The test is meaningless for super-user.
 	exit 77
 else
@@ -4940,7 +4940,7 @@
 export TAR_OPTIONS
 rm -rf *
 
-if test -w / ; then
+if test -w // ; then
 	# The test is meaningless for super-user.
 	exit 77
 else
@@ -4985,7 +4985,7 @@
 export TAR_OPTIONS
 rm -rf *
 
-if test -w / ; then
+if test -w // ; then
 	# The test is meaningless for super-user.
 	exit 77
 else
