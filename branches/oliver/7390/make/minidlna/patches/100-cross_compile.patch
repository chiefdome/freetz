--- genconfig.sh
+++ genconfig.sh
@@ -14,8 +14,8 @@
 DB_PATH="/tmp/minidlna"
 
 # detecting the OS name and version
-OS_NAME=`uname -s`
-OS_VERSION=`uname -r`
+OS_NAME="FRITZ!Box"
+OS_URL="http://sourceforge.net/projects/minidlna/"
 TIVO="/*#define TIVO_SUPPORT*/"
 NETGEAR="/*#define NETGEAR*/"
 READYNAS="/*#define READYNAS*/"
@@ -24,22 +24,22 @@
 
 # Detect if there are missing headers
 # NOTE: This check only works with a normal distro
-[ ! -e "/usr/include/sqlite3.h" ] && MISSING="libsqlite3 $MISSING"
-[ ! -e "/usr/include/jpeglib.h" ] && MISSING="libjpeg $MISSING"
-[ ! -e "/usr/include/libexif/exif-loader.h" ] && MISSING="libexif $MISSING"
-[ ! -e "/usr/include/id3tag.h" ] && MISSING="libid3tag $MISSING"
-[ ! -e "/usr/include/ogg/ogg.h" ] && MISSING="libogg $MISSING"
-[ ! -e "/usr/include/vorbis/codec.h" ] && MISSING="libvorbis $MISSING"
-[ ! -e "/usr/include/FLAC/metadata.h" ] && MISSING="libflac $MISSING"
-[ ! -e "/usr/include/ffmpeg/avutil.h" -a \
-  ! -e "/usr/include/libavutil/avutil.h" -a \
-  ! -e "/usr/include/ffmpeg/libavutil/avutil.h" ] && MISSING="libavutil $MISSING"
-[ ! -e "/usr/include/ffmpeg/avformat.h" -a \
-  ! -e "/usr/include/libavformat/avformat.h" -a \
-  ! -e "/usr/include/ffmpeg/libavformat/avformat.h" ] && MISSING="libavformat $MISSING"
-[ ! -e "/usr/include/ffmpeg/avcodec.h" -a \
-  ! -e "/usr/include/libavcodec/avcodec.h" -a \
-  ! -e "/usr/include/ffmpeg/libavcodec/avcodec.h" ] && MISSING="libavcodec $MISSING"
+[ ! -e "${CROSS_TOOLCHAIN_SYSROOT}/usr/include/sqlite3.h" ] && MISSING="libsqlite3 $MISSING"
+[ ! -e "${CROSS_TOOLCHAIN_SYSROOT}/usr/include/jpeglib.h" ] && MISSING="libjpeg $MISSING"
+[ ! -e "${CROSS_TOOLCHAIN_SYSROOT}/usr/include/libexif/exif-loader.h" ] && MISSING="libexif $MISSING"
+[ ! -e "${CROSS_TOOLCHAIN_SYSROOT}/usr/include/id3tag.h" ] && MISSING="libid3tag $MISSING"
+[ ! -e "${CROSS_TOOLCHAIN_SYSROOT}/usr/include/ogg/ogg.h" ] && MISSING="libogg $MISSING"
+[ ! -e "${CROSS_TOOLCHAIN_SYSROOT}/usr/include/vorbis/codec.h" ] && MISSING="libvorbis $MISSING"
+[ ! -e "${CROSS_TOOLCHAIN_SYSROOT}/usr/include/FLAC/metadata.h" ] && MISSING="libflac $MISSING"
+[ ! -e "${CROSS_TOOLCHAIN_SYSROOT}/usr/include/ffmpeg/avutil.h" -a \
+  ! -e "${CROSS_TOOLCHAIN_SYSROOT}/usr/include/libavutil/avutil.h" -a \
+  ! -e "${CROSS_TOOLCHAIN_SYSROOT}/usr/include/ffmpeg/libavutil/avutil.h" ] && MISSING="libavutil $MISSING"
+[ ! -e "${CROSS_TOOLCHAIN_SYSROOT}/usr/include/ffmpeg/avformat.h" -a \
+  ! -e "${CROSS_TOOLCHAIN_SYSROOT}/usr/include/libavformat/avformat.h" -a \
+  ! -e "${CROSS_TOOLCHAIN_SYSROOT}/usr/include/ffmpeg/libavformat/avformat.h" ] && MISSING="libavformat $MISSING"
+[ ! -e "${CROSS_TOOLCHAIN_SYSROOT}/usr/include/ffmpeg/avcodec.h" -a \
+  ! -e "${CROSS_TOOLCHAIN_SYSROOT}/usr/include/libavcodec/avcodec.h" -a \
+  ! -e "${CROSS_TOOLCHAIN_SYSROOT}/usr/include/ffmpeg/libavcodec/avcodec.h" ] && MISSING="libavcodec $MISSING"
 if [ -n "$MISSING" ]; then
 	echo -e "\nERROR!  Cannot continue."
 	echo -e "The following required libraries are either missing, or are missing development headers:\n"
@@ -55,90 +55,7 @@
 echo "#define $CONFIGMACRO" >> ${CONFIGFILE}
 echo "" >> ${CONFIGFILE}
 
-# OS Specific stuff
-case $OS_NAME in
-	OpenBSD)
-		MAJORVER=`echo $OS_VERSION | cut -d. -f1`
-		MINORVER=`echo $OS_VERSION | cut -d. -f2`
-		#echo "OpenBSD majorversion=$MAJORVER minorversion=$MINORVER"
-		# rtableid was introduced in OpenBSD 4.0
-		if [ $MAJORVER -ge 4 ]; then
-			echo "#define PFRULE_HAS_RTABLEID" >> ${CONFIGFILE}
-		fi
-		# from the 3.8 version, packets and bytes counters are double : in/out
-		if [ \( $MAJORVER -ge 4 \) -o \( $MAJORVER -eq 3 -a $MINORVER -ge 8 \) ]; then
-			echo "#define PFRULE_INOUT_COUNTS" >> ${CONFIGFILE}
-		fi
-		OS_URL=http://www.openbsd.org/
-		;;
-	FreeBSD)
-		VER=`grep '#define __FreeBSD_version' /usr/include/sys/param.h | awk '{print $3}'`
-		if [ $VER -ge 700049 ]; then
-			echo "#define PFRULE_INOUT_COUNTS" >> ${CONFIGFILE}
-		fi
-		OS_URL=http://www.freebsd.org/
-		;;
-	pfSense)
-		# we need to detect if PFRULE_INOUT_COUNTS macro is needed
-		OS_URL=http://www.pfsense.com/
-		;;
-	NetBSD)
-		OS_URL=http://www.netbsd.org/
-		;;
-	SunOS)
-		echo "#define USE_IPF 1" >> ${CONFIGFILE}
-		echo "#define LOG_PERROR 0" >> ${CONFIGFILE}
-		echo "#define SOLARIS_KSTATS 1" >> ${CONFIGFILE}
-		echo "typedef uint64_t u_int64_t;" >> ${CONFIGFILE}
-		echo "typedef uint32_t u_int32_t;" >> ${CONFIGFILE}
-		echo "typedef uint16_t u_int16_t;" >> ${CONFIGFILE}
-		echo "typedef uint8_t u_int8_t;" >> ${CONFIGFILE}
-		OS_URL=http://www.sun.com/solaris/
-		;;
-	Linux)
-		OS_URL=http://www.kernel.org/
-		KERNVERA=`echo $OS_VERSION | awk -F. '{print $1}'`
-		KERNVERB=`echo $OS_VERSION | awk -F. '{print $2}'`
-		KERNVERC=`echo $OS_VERSION | awk -F. '{print $3}'`
-		KERNVERD=`echo $OS_VERSION | awk -F. '{print $4}'`
-		#echo "$KERNVERA.$KERNVERB.$KERNVERC.$KERNVERD"
-		# NETGEAR ReadyNAS special case
-		if [ -f /etc/raidiator_version ]; then
-			OS_NAME=$(awk -F'!!|=' '{ print $1 }' /etc/raidiator_version)
-			OS_VERSION=$(awk -F'!!|[=,.]' '{ print $3"."$4 }' /etc/raidiator_version)
-			OS_URL="http://www.readynas.com/"
-			DB_PATH="/var/cache/minidlna"
-			TIVO="#define TIVO_SUPPORT"
-			NETGEAR="#define NETGEAR"
-			READYNAS="#define READYNAS"
-		# Debian GNU/Linux special case
-		elif [ -f /etc/debian_version ]; then
-			OS_NAME=Debian
-			OS_VERSION=`cat /etc/debian_version`
-			OS_URL=http://www.debian.org/
-			# use lsb_release (Linux Standard Base) when available
-			LSB_RELEASE=`which lsb_release 2>/dev/null`
-			if [ 0 -eq $? ]; then
-				OS_NAME=`${LSB_RELEASE} -i -s`
-				OS_VERSION=`${LSB_RELEASE} -r -s`
-			fi
-		else
-			# use lsb_release (Linux Standard Base) when available
-			LSB_RELEASE=`which lsb_release 2>/dev/null`
-			if [ 0 -eq $? ]; then
-				OS_NAME=`${LSB_RELEASE} -i -s`
-				OS_VERSION=`${LSB_RELEASE} -r -s`
-			fi
-		fi
-		;;
-	*)
-		echo "Unknown OS : $OS_NAME"
-		exit 1
-		;;
-esac
-
 echo "#define OS_NAME		\"$OS_NAME\"" >> ${CONFIGFILE}
-echo "#define OS_VERSION	\"$OS_NAME/$OS_VERSION\"" >> ${CONFIGFILE}
 echo "#define OS_URL		\"${OS_URL}\"" >> ${CONFIGFILE}
 echo "" >> ${CONFIGFILE}
 
@@ -152,7 +69,7 @@
 echo "" >> ${CONFIGFILE}
 
 echo "/* Enable if the system inotify.h exists.  Otherwise our own inotify.h will be used. */" >> ${CONFIGFILE}
-if [ -f /usr/include/sys/inotify.h ]; then
+if [ -f ${CROSS_TOOLCHAIN_SYSROOT}/usr/include/sys/inotify.h ]; then
 echo "#define HAVE_INOTIFY_H" >> ${CONFIGFILE}
 else
 echo "/*#define HAVE_INOTIFY_H*/" >> ${CONFIGFILE}
@@ -160,7 +77,7 @@
 echo "" >> ${CONFIGFILE}
 
 echo "/* Enable if the system iconv.h exists.  ID3 tag reading in various character sets will not work properly otherwise. */" >> ${CONFIGFILE}
-if [ -f /usr/include/iconv.h ]; then
+if [ -f ${CROSS_TOOLCHAIN_SYSROOT}/usr/include/iconv.h ]; then
 echo "#define HAVE_ICONV_H" >> ${CONFIGFILE}
 else
 echo -e "\nWARNING!!  Iconv support not found.  ID3 tag reading may not work."
@@ -169,11 +86,11 @@
 echo "" >> ${CONFIGFILE}
 
 echo "/* Enable if the system libintl.h exists for NLS support. */" >> ${CONFIGFILE}
-if [ -f /usr/include/libintl.h ]; then
-echo "#define ENABLE_NLS" >> ${CONFIGFILE}
-else
+#if [ -f ${CROSS_TOOLCHAIN_SYSROOT}/usr/include/libintl.h ]; then
+#echo "#define ENABLE_NLS" >> ${CONFIGFILE}
+#else
 echo "/*#define ENABLE_NLS*/" >> ${CONFIGFILE}
-fi
+#fi
 echo "" >> ${CONFIGFILE}
 
 echo "/* Enable NETGEAR-specific tweaks. */" >> ${CONFIGFILE}
--- Makefile
+++ Makefile
@@ -10,13 +10,9 @@
 # or :
 # $ make install
 #
-#CFLAGS = -Wall -O -D_GNU_SOURCE -g -DDEBUG
-#CFLAGS = -Wall -g -Os -D_GNU_SOURCE
-CFLAGS = -Wall -g -O3 -D_GNU_SOURCE -D_FILE_OFFSET_BITS=64 \
-	 -I/usr/include/ffmpeg \
-	 -I/usr/include/libavutil -I/usr/include/libavcodec -I/usr/include/libavformat \
-	 -I/usr/include/ffmpeg/libavutil -I/usr/include/ffmpeg/libavcodec -I/usr/include/ffmpeg/libavformat
-#STATIC_LINKING: LDFLAGS = -static
+CFLAGS = -Wall -D_GNU_SOURCE -pthread
+CPPFLAGS = -I$(CROSS_TOOLCHAIN_SYSROOT)/usr/include/libavutil -I$(CROSS_TOOLCHAIN_SYSROOT)/usr/include/libavcodec -I$(CROSS_TOOLCHAIN_SYSROOT)/usr/include/libavformat
+
 CC = gcc
 RM = rm -f
 INSTALL = install
@@ -34,16 +30,20 @@
            tagutils/textutils.o tagutils/misc.o tagutils/tagutils.o \
            playlist.o image_utils.o albumart.o log.o
 
-ALLOBJS = $(BASEOBJS) $(LNXOBJS)
+ALLOBJS = $(BASEOBJS)
 
-LIBS = -lpthread -lexif -ljpeg -lsqlite3 -lavformat -lid3tag -lFLAC -lvorbis
-#STATIC_LINKING: LIBS = -lvorbis -logg -lm -lsqlite3 -lpthread -lexif -ljpeg -lFLAC -lm -lid3tag -lz -lavformat -lavutil -lavcodec -lm
+ifeq ($(strip $(LINK_STATICALLY)),yes)
+LDFLAGS = -static
+LIBS = -lvorbis -logg -lsqlite3 -lexif -ljpeg -lFLAC -lid3tag -lavformat -lavcodec -lavutil -lpthread -lz -lm -ldl $(ICONV_LIB)
+else
+LIBS = -lpthread -lexif -ljpeg -lsqlite3 -lavformat -lid3tag -lFLAC -lvorbis $(ICONV_LIB)
+endif
 
 TESTUPNPDESCGENOBJS = testupnpdescgen.o upnpdescgen.o
 
 EXECUTABLES = minidlna testupnpdescgen
 
-.PHONY:	all clean install depend
+.PHONY:	all clean install
 
 all:	$(EXECUTABLES)
 
@@ -52,27 +52,17 @@
 	$(RM) $(EXECUTABLES)
 	$(RM) testupnpdescgen.o
 
-install:	minidlna
+install: minidlna
 	$(INSTALL) -d $(SBININSTALLDIR)
 	$(INSTALL) minidlna $(SBININSTALLDIR)
 	$(INSTALL) -d $(ETCINSTALLDIR)
 	$(INSTALL) --mode=0644 minidlna.conf $(ETCINSTALLDIR)
 
-minidlna:	$(BASEOBJS) $(LNXOBJS) $(LIBS)
-	@echo Linking $@
-	@$(CC) $(CFLAGS) $(LDFLAGS) -o $@ $(BASEOBJS) $(LNXOBJS) $(LIBS)
-
-
-testupnpdescgen:	$(TESTUPNPDESCGENOBJS)
-	@echo Linking $@
-	@$(CC) $(CFLAGS) -o $@ $(TESTUPNPDESCGENOBJS)
-
-config.h:	genconfig.sh
-	./genconfig.sh
+minidlna: $(BASEOBJS)
+	$(CC) $(CFLAGS) $(CPPFLAGS) $(LDFLAGS) -o $@ $(BASEOBJS) $(LIBS)
 
-depend:	config.h
-	makedepend -f$(MAKEFILE_LIST) -Y \
-	$(ALLOBJS:.o=.c) $(TESTUPNPDESCGENOBJS:.o=.c) 2>/dev/null
+testupnpdescgen: $(TESTUPNPDESCGENOBJS)
+	$(CC) $(CFLAGS) $(CPPFLAGS) -o $@ $(TESTUPNPDESCGENOBJS)
 
 # DO NOT DELETE
 
@@ -122,8 +112,4 @@
 .SUFFIXES: .c .o
 
 .c.o:
-	@echo Compiling $*.c
-	@$(CC) $(CFLAGS) -o $@ -c $< && exit 0;\
-		echo "The following command failed:" 1>&2;\
-		echo "$(CC) $(CFLAGS) -o $@ -c $<";\
-		$(CC) $(CFLAGS) -o $@ -c $< &>/dev/null
+	$(CC) $(CFLAGS) $(CPPFLAGS) -o $@ -c $<
--- upnphttp.h
+++ upnphttp.h
@@ -14,7 +14,7 @@
 #include "config.h"
 
 /* server: HTTP header returned in all HTTP responses : */
-#define MINIDLNA_SERVER_STRING	OS_VERSION " DLNADOC/1.50 UPnP/1.0 MiniDLNA/1.0"
+#define MINIDLNA_SERVER_STRING	"DLNADOC/1.50 UPnP/1.0 MiniDLNA/1.0"
 
 /*
  states :
