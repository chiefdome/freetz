#!/bin/sh

DAEMON=tinyproxy

. /etc/init.d/modlibrc

start() {
	if [ ! -r /tmp/flash/tinyproxy.conf ]; then
		echo "Copying /etc/default.tinyproxy/default.conf to flash"
		cp /mod/etc/default.tinyproxy/default.conf /tmp/flash/tinyproxy.conf
	fi
	if [ ! -r /tmp/flash/tinyproxy.filter ]; then
		echo "Copying /etc/default.tinyproxy/default.filter to flash"
		cp /mod/etc/default.tinyproxy/default.filter /tmp/flash/tinyproxy.filter
	fi

	{
		if [ -x "/tmp/flash/${DAEMON}_conf" ]; then
			/tmp/flash/${DAEMON}_conf
		else
			/mod/etc/default.$DAEMON/${DAEMON}_conf
		fi

		if [ -r "/tmp/flash/${DAEMON}.extra" ]; then
			cat /tmp/flash/${DAEMON}.extra
		fi
	} > /mod/etc/$DAEMON.conf


	echo -n "Starting $DAEMON server ... "
	$DAEMON -c /mod/etc/$DAEMON.conf
	exitval=$?
	if [ "$exitval" -eq 0 ]; then
		echo 'done.'
	else
		echo 'failed.'
		exit $exitval
	fi

	if [ "$TINYPROXY_CATCHALL" == "yes" ]; then
		echo -n "Configuring IPTABLES to make all web traffic go through tinyproxy ... "
		/usr/sbin/iptables -t nat -A PREROUTING -i lan -p tcp --dport 80 -j REDIRECT --to-port $TINYPROXY_PORT
		echo "done."
	fi

	if [ "$TINYPROXY_CONFSERVER" == "yes" ]; then
		echo -n "Starting the webserver for the proxy config file ... "
		httpd -p $TINYPROXY_CONFSERVERPORT -h /mod/usr/mww_tinyproxy
		echo "done."
	fi
}

stop() {
	echo -n "Stopping $DAEMON server..."
	killall $DAEMON > /dev/null 2>&1
	exitval=$?
	if [ "$exitval" -eq 0 ]; then
		echo 'done.'
	else
		echo 'failed.'
	fi

	if [ "$TINYPROXY_CATCHALL" == "yes" ]; then
		echo -n "Removing tinyproxy IPTABLES rules if any ... "
		/usr/sbin/iptables -t nat -D PREROUTING -i lan -p tcp --dport 80 -j REDIRECT --to-port $TINYPROXY_PORT
		echo "done."
	fi

	if [ "$TINYPROXY_CONFSERVER" == "yes" ]; then
		echo -n "Stopping the webserver for the proxy config file ... "
		pid="$(ps aux | egrep "httpd\ -p.*tinyproxy" | cut -d ' ' -f 2)"
		kill -9 $pid > /dev/null 2>&1
		exitval=$?
		if [ "$exitval" -eq 0 ]; then
			echo 'done.'
		else
			echo 'failed.'
		fi
	fi
}

case "$1" in
	""|load)
		modreg cgi 'tinyproxy' 'tinyproxy'

		modreg file tinyproxy conf 'tinyproxy conf' 0 "tinyproxy_conf"
		modreg file tinyproxy filter 'tinyproxy filter' 0 "tinyproxy_filter"
		
		if [ "$TINYPROXY_ENABLED" != "yes" ]; then
			echo "$DAEMON is disabled" 1>&2
			exit 1;
		fi

		start
		;;
	unload)
		stop
		modunreg file tinyproxy
		modunreg cgi tinyproxy
		;;
	start)
		start
		;;
	stop)
		stop
		;;
	restart)
		stop
		sleep 1
		start
		;;
	status)
		if [ -z "$(pidof "$DAEMON")" ]; then
			echo 'stopped'
		else
			echo 'running'
		fi
		;;
esac

exit 0
